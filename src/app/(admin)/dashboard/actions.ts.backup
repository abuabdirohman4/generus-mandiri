"use server";

import { createClient } from '@/lib/supabase/server';
import { handleApiError } from '@/lib/errorUtils';
import { getCurrentUserProfile, getDataFilter } from '@/lib/accessControlServer';

export interface TodayMeeting {
  id: string;
  title: string;
  date: string;
  class_id: string;
  class_name: string;
  teacher_name: string;
  meeting_type_code: string | null;
  total_students: number;
  present_count: number;
  attendance_percentage: number;
}

export interface ClassPerformance {
  class_id: string;
  class_name: string;
  attendance_percentage: number;
  total_meetings: number;
}

export interface MeetingTypeDistribution {
  type: string;
  label: string;
  count: number;
}

export interface DashboardFilters {
  daerahId?: string;
  desaId?: string;
  kelompokId?: string;
  classId?: string;
}

export interface Dashboard {
  // Core Stats
  siswa: number;
  kelas: number;

  // Meeting Stats
  meetingsToday: number;
  meetingsWeekly: number;
  meetingsMonthly: number;

  // Attendance Stats
  kehadiranHariIni: number;
  kehadiranMingguan: number;
  kehadiranBulanan: number;

  // Today's Meetings
  todayMeetings: TodayMeeting[];

  // Class Performance
  topClasses: ClassPerformance[];
  bottomClasses: ClassPerformance[];

  // Charts
  attendanceTrend: Array<{ date: string; attendance: number }>;
  meetingTypeDistribution: MeetingTypeDistribution[];
}

export async function getDashboard(filters?: DashboardFilters): Promise<Dashboard> {
  try {
    const supabase = await createClient();
    const profile = await getCurrentUserProfile();
    const rlsFilter = profile ? getDataFilter(profile) : null;

    // Define date ranges using Jakarta timezone
    const jakartaDate = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Jakarta" }));
    const today = jakartaDate.toISOString().split('T')[0];

    const weekAgo = new Date(jakartaDate);
    weekAgo.setDate(weekAgo.getDate() - 7);
    const weekAgoStr = weekAgo.toISOString().split('T')[0];

    const monthAgo = new Date(jakartaDate);
    monthAgo.setDate(monthAgo.getDate() - 30);
    const monthAgoStr = monthAgo.toISOString().split('T')[0];

    // Get basic counts with filtering
    let siswaQuery = supabase.from('students').select('*', { count: 'exact', head: true });
    let kelasQuery = supabase.from('classes').select('*', { count: 'exact', head: true });

    // Apply filtering - prioritize UI filters over RLS
    if (filters?.classId) {
      // Direct class filter - get students in this class
      const { data: studentClasses } = await supabase.from('student_classes').select('student_id').eq('class_id', filters.classId);
      const studentIds = studentClasses?.map(sc => sc.student_id) || [];
      if (studentIds.length > 0) {
        siswaQuery = siswaQuery.in('id', studentIds);
      } else {
        siswaQuery = siswaQuery.eq('id', 'none'); // No students
      }
      kelasQuery = kelasQuery.eq('id', filters.classId);
    } else if (filters?.kelompokId) {
      siswaQuery = siswaQuery.eq('kelompok_id', filters.kelompokId);
      kelasQuery = kelasQuery.eq('kelompok_id', filters.kelompokId);
    } else if (filters?.desaId) {
      siswaQuery = siswaQuery.eq('desa_id', filters.desaId);

      // Get kelompok IDs for classes filtering
      const { data: kelompokIds } = await supabase.from('kelompok').select('id').eq('desa_id', filters.desaId);
      const kelompokIdList = kelompokIds?.map(k => k.id) || [];
      if (kelompokIdList.length > 0) {
        kelasQuery = kelasQuery.in('kelompok_id', kelompokIdList);
      } else {
        kelasQuery = kelasQuery.eq('id', 'none');
      }
    } else if (filters?.daerahId) {
      siswaQuery = siswaQuery.eq('daerah_id', filters.daerahId);

      // Get desa IDs for kelompok and classes filtering
      const { data: desaIds } = await supabase.from('desa').select('id').eq('daerah_id', filters.daerahId);
      const desaIdList = desaIds?.map(d => d.id) || [];
      if (desaIdList.length > 0) {
        // Get kelompok IDs for classes filtering
        const { data: kelompokIds } = await supabase.from('kelompok').select('id').in('desa_id', desaIdList);
        const kelompokIdList = kelompokIds?.map(k => k.id) || [];
        if (kelompokIdList.length > 0) {
          kelasQuery = kelasQuery.in('kelompok_id', kelompokIdList);
        } else {
          kelasQuery = kelasQuery.eq('id', 'none');
        }
      } else {
        kelasQuery = kelasQuery.eq('id', 'none');
      }
    } else if (rlsFilter?.daerah_id) {
      // Fall back to RLS-based filtering
      siswaQuery = siswaQuery.eq('daerah_id', rlsFilter.daerah_id);

      // Get desa IDs for kelompok and classes filtering
      const { data: desaIds } = await supabase.from('desa').select('id').eq('daerah_id', rlsFilter.daerah_id);
      const desaIdList = desaIds?.map(d => d.id) || [];
      if (desaIdList.length > 0) {
        // Get kelompok IDs for classes filtering
        const { data: kelompokIds } = await supabase.from('kelompok').select('id').in('desa_id', desaIdList);
        const kelompokIdList = kelompokIds?.map(k => k.id) || [];
        if (kelompokIdList.length > 0) {
          kelasQuery = kelasQuery.in('kelompok_id', kelompokIdList);
        }
      }
    } else if (rlsFilter?.desa_id) {
      siswaQuery = siswaQuery.eq('desa_id', rlsFilter.desa_id);

      // Get kelompok IDs for classes filtering
      const { data: kelompokIds } = await supabase.from('kelompok').select('id').eq('desa_id', rlsFilter.desa_id);
      const kelompokIdList = kelompokIds?.map(k => k.id) || [];
      if (kelompokIdList.length > 0) {
        kelasQuery = kelasQuery.in('kelompok_id', kelompokIdList);
      }
    } else if (rlsFilter?.kelompok_id) {
      siswaQuery = siswaQuery.eq('kelompok_id', rlsFilter.kelompok_id);
      kelasQuery = kelasQuery.eq('kelompok_id', rlsFilter.kelompok_id);
    }

    const [
      { count: siswa },
      { count: kelas }
    ] = await Promise.all([
      siswaQuery,
      kelasQuery
    ]);

    // Get meetings data
    let meetingsQuery = supabase
      .from('meetings')
      .select(`
        id,
        title,
        date,
        class_id,
        meeting_type_code,
        classes:class_id(
          id,
          name,
          kelompok_id
        ),
        profiles:teacher_id(
          full_name
        )
      `)
      .order('date', { ascending: false });

    // Apply filtering to meetings based on class - prioritize UI filters
    if (filters?.classId) {
      meetingsQuery = meetingsQuery.eq('class_id', filters.classId);
    } else if (filters?.kelompokId) {
      const { data: validClasses } = await supabase
        .from('classes')
        .select('id')
        .eq('kelompok_id', filters.kelompokId);
      const validClassIds = validClasses?.map(c => c.id) || [];
      if (validClassIds.length > 0) {
        meetingsQuery = meetingsQuery.in('class_id', validClassIds);
      } else {
        meetingsQuery = meetingsQuery.eq('class_id', 'none');
      }
    } else if (filters?.desaId) {
      const { data: kelompokIds } = await supabase.from('kelompok').select('id').eq('desa_id', filters.desaId);
      const kelompokIdList = kelompokIds?.map(k => k.id) || [];
      if (kelompokIdList.length > 0) {
        const { data: validClasses } = await supabase
          .from('classes')
          .select('id')
          .in('kelompok_id', kelompokIdList);
        const validClassIds = validClasses?.map(c => c.id) || [];
        if (validClassIds.length > 0) {
          meetingsQuery = meetingsQuery.in('class_id', validClassIds);
        } else {
          meetingsQuery = meetingsQuery.eq('class_id', 'none');
        }
      } else {
        meetingsQuery = meetingsQuery.eq('class_id', 'none');
      }
    } else if (filters?.daerahId) {
      const { data: desaIds } = await supabase.from('desa').select('id').eq('daerah_id', filters.daerahId);
      const desaIdList = desaIds?.map(d => d.id) || [];
      if (desaIdList.length > 0) {
        const { data: kelompokIds } = await supabase.from('kelompok').select('id').in('desa_id', desaIdList);
        const kelompokIdList = kelompokIds?.map(k => k.id) || [];
        if (kelompokIdList.length > 0) {
          const { data: validClasses } = await supabase
            .from('classes')
            .select('id')
            .in('kelompok_id', kelompokIdList);
          const validClassIds = validClasses?.map(c => c.id) || [];
          if (validClassIds.length > 0) {
            meetingsQuery = meetingsQuery.in('class_id', validClassIds);
          } else {
            meetingsQuery = meetingsQuery.eq('class_id', 'none');
          }
        } else {
          meetingsQuery = meetingsQuery.eq('class_id', 'none');
        }
      } else {
        meetingsQuery = meetingsQuery.eq('class_id', 'none');
      }
    } else if (rlsFilter?.kelompok_id) {
      // Fall back to RLS filter
      const { data: validClasses } = await supabase
        .from('classes')
        .select('id')
        .eq('kelompok_id', rlsFilter.kelompok_id);
      const validClassIds = validClasses?.map(c => c.id) || [];
      if (validClassIds.length > 0) {
        meetingsQuery = meetingsQuery.in('class_id', validClassIds);
      } else {
        meetingsQuery = meetingsQuery.eq('class_id', 'none');
      }
    } else if (rlsFilter?.desa_id) {
      const { data: kelompokIds } = await supabase.from('kelompok').select('id').eq('desa_id', rlsFilter.desa_id);
      const kelompokIdList = kelompokIds?.map(k => k.id) || [];
      if (kelompokIdList.length > 0) {
        const { data: validClasses } = await supabase
          .from('classes')
          .select('id')
          .in('kelompok_id', kelompokIdList);
        const validClassIds = validClasses?.map(c => c.id) || [];
        if (validClassIds.length > 0) {
          meetingsQuery = meetingsQuery.in('class_id', validClassIds);
        } else {
          meetingsQuery = meetingsQuery.eq('class_id', 'none');
        }
      } else {
        meetingsQuery = meetingsQuery.eq('class_id', 'none');
      }
    } else if (rlsFilter?.daerah_id) {
      const { data: desaIds } = await supabase.from('desa').select('id').eq('daerah_id', rlsFilter.daerah_id);
      const desaIdList = desaIds?.map(d => d.id) || [];
      if (desaIdList.length > 0) {
        const { data: kelompokIds } = await supabase.from('kelompok').select('id').in('desa_id', desaIdList);
        const kelompokIdList = kelompokIds?.map(k => k.id) || [];
        if (kelompokIdList.length > 0) {
          const { data: validClasses } = await supabase
            .from('classes')
            .select('id')
            .in('kelompok_id', kelompokIdList);
          const validClassIds = validClasses?.map(c => c.id) || [];
          if (validClassIds.length > 0) {
            meetingsQuery = meetingsQuery.in('class_id', validClassIds);
          } else {
            meetingsQuery = meetingsQuery.eq('class_id', 'none');
          }
        } else {
          meetingsQuery = meetingsQuery.eq('class_id', 'none');
        }
      } else {
        meetingsQuery = meetingsQuery.eq('class_id', 'none');
      }
    }

    const { data: allMeetings } = await meetingsQuery;

    // Count meetings by period
    const meetingsToday = allMeetings?.filter(m => m.date === today).length || 0;
    const meetingsWeekly = allMeetings?.filter(m => m.date >= weekAgoStr).length || 0;
    const meetingsMonthly = allMeetings?.filter(m => m.date >= monthAgoStr).length || 0;

    // Get attendance logs for all periods
    let attendanceQuery = supabase
      .from('attendance_logs')
      .select('date, status, student_id, meeting_id')
      .gte('date', monthAgoStr);

    // Apply filtering to attendance logs - prioritize UI filters
    if (filters?.classId) {
      // For class filter, get students from student_classes
      const { data: studentClasses } = await supabase.from('student_classes').select('student_id').eq('class_id', filters.classId);
      const studentIdList = studentClasses?.map(sc => sc.student_id) || [];
      if (studentIdList.length > 0) {
        attendanceQuery = attendanceQuery.in('student_id', studentIdList);
      }
    } else if (filters?.kelompokId) {
      const { data: studentIds } = await supabase.from('students').select('id').eq('kelompok_id', filters.kelompokId);
      const studentIdList = studentIds?.map(s => s.id) || [];
      if (studentIdList.length > 0) {
        attendanceQuery = attendanceQuery.in('student_id', studentIdList);
      }
    } else if (filters?.desaId) {
      const { data: studentIds } = await supabase.from('students').select('id').eq('desa_id', filters.desaId);
      const studentIdList = studentIds?.map(s => s.id) || [];
      if (studentIdList.length > 0) {
        attendanceQuery = attendanceQuery.in('student_id', studentIdList);
      }
    } else if (filters?.daerahId) {
      const { data: studentIds } = await supabase.from('students').select('id').eq('daerah_id', filters.daerahId);
      const studentIdList = studentIds?.map(s => s.id) || [];
      if (studentIdList.length > 0) {
        attendanceQuery = attendanceQuery.in('student_id', studentIdList);
      }
    } else if (rlsFilter?.kelompok_id) {
      // Fall back to RLS filter
      const { data: studentIds } = await supabase.from('students').select('id').eq('kelompok_id', rlsFilter.kelompok_id);
      const studentIdList = studentIds?.map(s => s.id) || [];
      if (studentIdList.length > 0) {
        attendanceQuery = attendanceQuery.in('student_id', studentIdList);
      }
    } else if (rlsFilter?.desa_id) {
      const { data: studentIds } = await supabase.from('students').select('id').eq('desa_id', rlsFilter.desa_id);
      const studentIdList = studentIds?.map(s => s.id) || [];
      if (studentIdList.length > 0) {
        attendanceQuery = attendanceQuery.in('student_id', studentIdList);
      }
    } else if (rlsFilter?.daerah_id) {
      const { data: studentIds } = await supabase.from('students').select('id').eq('daerah_id', rlsFilter.daerah_id);
      const studentIdList = studentIds?.map(s => s.id) || [];
      if (studentIdList.length > 0) {
        attendanceQuery = attendanceQuery.in('student_id', studentIdList);
      }
    }

    const { data: attendanceData } = await attendanceQuery;

    // Calculate attendance percentages
    const todayAttendance = attendanceData?.filter(a => a.date === today) || [];
    const weekAttendance = attendanceData?.filter(a => a.date >= weekAgoStr) || [];
    const monthAttendance = attendanceData || [];

    const kehadiranHariIni = todayAttendance.length > 0
      ? Math.round((todayAttendance.filter(a => a.status === 'H').length / todayAttendance.length) * 100)
      : 0;

    const kehadiranMingguan = weekAttendance.length > 0
      ? Math.round((weekAttendance.filter(a => a.status === 'H').length / weekAttendance.length) * 100)
      : 0;

    const kehadiranBulanan = monthAttendance.length > 0
      ? Math.round((monthAttendance.filter(a => a.status === 'H').length / monthAttendance.length) * 100)
      : 0;

    // Get today's meetings with attendance stats
    const todayMeetingsList = allMeetings?.filter(m => m.date === today) || [];
    const todayMeetings: TodayMeeting[] = await Promise.all(
      todayMeetingsList.map(async (meeting: any) => {
        const { data: attendanceLogs } = await supabase
          .from('attendance_logs')
          .select('status')
          .eq('meeting_id', meeting.id);

        const totalStudents = attendanceLogs?.length || 0;
        const presentCount = attendanceLogs?.filter(a => a.status === 'H').length || 0;
        const attendancePercentage = totalStudents > 0 ? Math.round((presentCount / totalStudents) * 100) : 0;

        // Handle classes - Supabase returns it as an array
        const classData = Array.isArray(meeting.classes) ? meeting.classes[0] : meeting.classes;
        const teacherData = Array.isArray(meeting.profiles) ? meeting.profiles[0] : meeting.profiles;

        return {
          id: meeting.id,
          title: meeting.title,
          date: meeting.date,
          class_id: meeting.class_id,
          class_name: classData?.name || 'Unknown',
          teacher_name: teacherData?.full_name || 'Unknown',
          meeting_type_code: meeting.meeting_type_code,
          total_students: totalStudents,
          present_count: presentCount,
          attendance_percentage: attendancePercentage
        };
      })
    );

    // Calculate class performance (last 30 days)
    const classAttendanceMap = new Map<string, { totalLogs: number; presentLogs: number; meetings: Set<string> }>();

    monthAttendance.forEach((log: any) => {
      // Find meeting for this log
      const meeting = allMeetings?.find(m => m.id === log.meeting_id);
      if (!meeting?.class_id) return;

      const classId = meeting.class_id;
      const existing = classAttendanceMap.get(classId) || { totalLogs: 0, presentLogs: 0, meetings: new Set() };

      existing.totalLogs += 1;
      if (log.status === 'H') existing.presentLogs += 1;
      existing.meetings.add(log.meeting_id);

      classAttendanceMap.set(classId, existing);
    });

    const classPerformanceList: ClassPerformance[] = Array.from(classAttendanceMap.entries())
      .map(([classId, stats]) => {
        const meeting = allMeetings?.find(m => m.class_id === classId);
        const classData = Array.isArray(meeting?.classes) ? meeting?.classes[0] : meeting?.classes;
        return {
          class_id: classId,
          class_name: classData?.name || 'Unknown',
          attendance_percentage: stats.totalLogs > 0 ? Math.round((stats.presentLogs / stats.totalLogs) * 100) : 0,
          total_meetings: stats.meetings.size
        };
      })
      .filter(c => c.total_meetings > 0); // Only classes with meetings

    // Sort and get top/bottom 5
    const sortedPerformance = [...classPerformanceList].sort((a, b) => b.attendance_percentage - a.attendance_percentage);
    const topClasses = sortedPerformance.slice(0, 5);
    const bottomClasses = sortedPerformance.slice(-5).reverse();

    // Calculate attendance trend for last 7 days
    const attendanceTrend = [];
    for (let i = 6; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      const dateStr = date.toISOString().split('T')[0];

      const dayAttendance = attendanceData?.filter(item => item.date === dateStr) || [];
      const totalRecords = dayAttendance.length;
      const presentRecords = dayAttendance.filter(item => item.status === 'H').length;
      const attendancePercentage = totalRecords > 0 ? Math.round((presentRecords / totalRecords) * 100) : 0;

      attendanceTrend.push({
        date: dateStr,
        attendance: attendancePercentage
      });
    }

    // Calculate meeting type distribution
    const meetingTypeMap = new Map<string, number>();
    allMeetings?.filter(m => m.date >= monthAgoStr).forEach((meeting: any) => {
      const type = meeting.meeting_type_code || 'PEMBINAAN';
      meetingTypeMap.set(type, (meetingTypeMap.get(type) || 0) + 1);
    });

    const meetingTypeDistribution: MeetingTypeDistribution[] = Array.from(meetingTypeMap.entries()).map(([type, count]) => ({
      type,
      label: getMeetingTypeLabel(type),
      count
    }));

    return {
      siswa: siswa || 0,
      kelas: kelas || 0,
      meetingsToday,
      meetingsWeekly,
      meetingsMonthly,
      kehadiranHariIni,
      kehadiranMingguan,
      kehadiranBulanan,
      todayMeetings,
      topClasses,
      bottomClasses,
      attendanceTrend,
      meetingTypeDistribution
    };
  } catch (error) {
    console.error('Error fetching dashboard stats:', error);
    throw handleApiError(error, 'memuat data', 'Failed to fetch dashboard statistics');
  }
}

// Helper function to get meeting type label
function getMeetingTypeLabel(code: string): string {
  const labels: Record<string, string> = {
    'ASAD': 'ASAD',
    'PEMBINAAN': 'Pembinaan',
    'SAMBUNG_KELOMPOK': 'Sambung Kelompok',
    'SAMBUNG_DESA': 'Sambung Desa',
    'SAMBUNG_DAERAH': 'Sambung Daerah',
    'SAMBUNG_PUSAT': 'Sambung Pusat'
  };
  return labels[code] || code;
}
