{"id":"sm-37l","status":"closed","title":"Document unit testing strategy in CLAUDE.md","priority":2,"issue_type":"task","created_at":"2026-02-10T08:32:10.403811+07:00","created_by":"abuabdirohman","updated_at":"2026-02-10T10:25:16.505951+07:00","closed_at":"2026-02-10T10:25:16.505951+07:00","close_reason":"Completed comprehensive unit testing documentation in CLAUDE.md. Includes: testing stack (Vitest), priority strategy, setup instructions, example tests, coverage goals, and 3-phase roadmap.","dependencies":[{"issue_id":"sm-37l","depends_on_id":"sm-qrt","type":"blocks","created_at":"2026-02-10T08:32:49.584523+07:00","created_by":"abuabdirohman"}]}
{"id":"sm-3ud","status":"closed","title":"Fix Missing Data for Guru Desa/Daerah","description":"Fix missing data for Guru Desa/Daerah (hierarchical teachers). Root cause: Core data fetching functions only supported regular teachers with teacher_classes, not hierarchical teachers with organizational IDs. Phase 1 complete (7 files modified, 5 bugs fixed, 159/159 tests passing). Phase 2 pending: meeting detail page and CreateMeetingModal.","priority":2,"issue_type":"feature","created_at":"2026-02-22T08:51:52.183326+07:00","created_by":"abuabdirohman","updated_at":"2026-02-22T09:16:45.110577+07:00","closed_at":"2026-02-22T02:16:32.87Z"}
{"id":"sm-6gn","status":"closed","title":"Write tests for utility functions (Priority 1)","priority":2,"issue_type":"task","created_at":"2026-02-10T08:32:12.306887+07:00","created_by":"abuabdirohman","updated_at":"2026-02-10T12:41:01.656665+07:00","closed_at":"2026-02-10T12:41:01.656665+07:00","close_reason":"‚úÖ Phase 2 Complete! All Priority 1 utilities tested with 60/60 tests passing.\n\nCoverage achieved:\n- accessControlServer.ts: 69% statements, 100% branches, 80% functions\n- attendanceCalculation.ts: 68% statements, 100% branches, 83% functions  \n- userUtils.ts: 100% statements, 87.5% branches, 100% functions\n- utils.ts: 91% statements, 64% branches, 87.5% functions\n- classHelpers.ts: 100% coverage (Phase 1)\n- batchFetching.ts: 100% coverage (Phase 1)\n\nTest files created:\n- src/lib/__tests__/accessControlServer.test.ts (14 tests)\n- src/lib/utils/__tests__/attendanceCalculation.test.ts (12 tests)\n- src/lib/__tests__/userUtils.test.ts (5 tests)\n- src/lib/__tests__/utils.test.ts (8 tests)\n\nAverage coverage: ~88% across all Priority 1 utilities. Exceeded target of 70-80%!","dependencies":[{"issue_id":"sm-6gn","depends_on_id":"sm-qrt","type":"blocks","created_at":"2026-02-10T08:32:58.235922+07:00","created_by":"abuabdirohman"}]}
{"id":"sm-8yf","status":"closed","title":"Feature: Student management actions (Archive, Transfer, Soft Delete, Hard Delete) with teacher permissions","description":"## Overview\nImplement student lifecycle management with approval-based transfer workflow. Students can be archived (graduated/inactive), transferred with approval system, and deleted (soft/hard) with role-based permissions.\n\n## üéØ Key Features\n\n### 1. Archive Student (with Status)\n**No approval needed** - Immediate action\n\n### 2. **Transfer Student (Approval-Based Workflow)** ‚≠ê NEW APPROACH\n**Cross-boundary transfers allowed with approval system**\n\n### 3. Soft Delete (Restorable)\n**No approval needed** - Immediate action\n\n### 4. Hard Delete (Permanent)\n**Superadmin only** - No approval needed\n\n---\n\n## üîÑ Transfer Workflow (Approval-Based System)\n\n### Core Principles:\n1. ‚úÖ **Can request transfer anywhere** (no hard boundaries)\n2. ‚úÖ **Auto-approved if within same organization scope**\n3. ‚úÖ **Needs approval if crossing organizational boundaries**\n4. ‚úÖ **Reviewer must have authority over destination organization**\n5. ‚úÖ **Support bulk transfers** (multiple students in one request)\n\n### Transfer Rules:\n\n| Scenario | Auto-Approved? | Reviewer Needed? |\n|----------|---------------|------------------|\n| Same Kelompok (class change only) | ‚úÖ Yes | ‚ùå No |\n| Different Kelompok, Same Desa | ‚úÖ Yes | ‚ùå No |\n| Different Desa, Same Daerah | ‚ùå No | ‚úÖ Admin Desa (target) |\n| Different Daerah | ‚ùå No | ‚úÖ Admin Daerah (target) |\n| Superadmin transfer | ‚úÖ Yes (bypass) | ‚ùå No |\n\n### Request Status Flow:\n```\n[Created] ‚Üí pending\n    ‚Üì\n    ‚îú‚îÄ‚Üí Auto-approved (same org) ‚Üí approved ‚Üí executed\n    ‚îÇ\n    ‚îî‚îÄ‚Üí Needs approval (cross-boundary) ‚Üí pending\n            ‚Üì\n            ‚îú‚îÄ‚Üí [Reviewer: Approve] ‚Üí approved ‚Üí executed\n            ‚îÇ\n            ‚îú‚îÄ‚Üí [Reviewer: Reject] ‚Üí rejected (can re-submit)\n            ‚îÇ\n            ‚îî‚îÄ‚Üí [Requester: Cancel] ‚Üí cancelled\n```\n\n---\n\n## üóÑÔ∏è Database Schema\n\n### New Table: transfer_requests\n```sql\nCREATE TABLE transfer_requests (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  \n  -- Students being transferred (supports bulk)\n  student_ids UUID[] NOT NULL, -- Array of student IDs\n  \n  -- Source organization (current)\n  from_daerah_id UUID REFERENCES daerah(id),\n  from_desa_id UUID REFERENCES desa(id),\n  from_kelompok_id UUID REFERENCES kelompok(id),\n  \n  -- Destination organization (target)\n  to_daerah_id UUID REFERENCES daerah(id),\n  to_desa_id UUID REFERENCES desa(id),\n  to_kelompok_id UUID REFERENCES kelompok(id),\n  to_class_ids UUID[], -- Optional: specific classes to assign\n  \n  -- Request metadata\n  requested_by UUID REFERENCES profiles(id) NOT NULL,\n  requested_at TIMESTAMPTZ DEFAULT NOW(),\n  reason TEXT, -- Required for cross-boundary transfers\n  notes TEXT,\n  \n  -- Approval workflow\n  status VARCHAR(20) DEFAULT 'pending' \n    CHECK (status IN ('pending', 'approved', 'rejected', 'cancelled')),\n  \n  reviewed_by UUID REFERENCES profiles(id),\n  reviewed_at TIMESTAMPTZ,\n  review_notes TEXT,\n  \n  -- Execution\n  executed_at TIMESTAMPTZ,\n  executed_by UUID REFERENCES profiles(id),\n  \n  -- Audit\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\nCREATE INDEX idx_transfer_requests_status ON transfer_requests(status);\nCREATE INDEX idx_transfer_requests_students ON transfer_requests USING GIN(student_ids);\nCREATE INDEX idx_transfer_pending_target ON transfer_requests(to_daerah_id, to_desa_id, to_kelompok_id) \n  WHERE status = 'pending';\nCREATE INDEX idx_transfer_requester ON transfer_requests(requested_by);\n```\n\n### Update: students table\n```sql\nALTER TABLE students\n  ADD COLUMN status VARCHAR(20) DEFAULT 'active'\n    CHECK (status IN ('active', 'graduated', 'inactive')),\n  ADD COLUMN archived_at TIMESTAMPTZ,\n  ADD COLUMN archived_by UUID REFERENCES profiles(id),\n  ADD COLUMN archive_notes TEXT,\n  ADD COLUMN transfer_history JSONB DEFAULT '[]'::jsonb;\n  -- deleted_at already exists\n\nCREATE INDEX idx_students_status ON students(status);\nCREATE INDEX idx_students_archived ON students(archived_at) WHERE archived_at IS NOT NULL;\n```\n\n### Update: profiles table\n```sql\nALTER TABLE profiles\n  ADD COLUMN permissions JSONB DEFAULT '{\n    \"can_archive_students\": false,\n    \"can_transfer_students\": false,\n    \"can_soft_delete_students\": false\n  }'::jsonb,\n  ADD COLUMN notification_badge JSONB DEFAULT '{\n    \"pending_transfer_requests\": 0\n  }'::jsonb;\n\nCREATE INDEX idx_profiles_permissions ON profiles USING GIN(permissions);\n```\n\n---\n\n## üìã Implementation Tasks\n\n### Phase 1: Database \u0026 Permissions (Priority: High)\n- [ ] Migration: `transfer_requests` table\n- [ ] Migration: `students` status fields\n- [ ] Migration: `profiles.permissions` JSONB\n- [ ] RLS policies for `transfer_requests`\n- [ ] **TDD**: Write tests for permission utilities ‚úÖ DONE\n  - `canRequestTransfer()` ‚úÖ\n  - `canReviewTransferRequest()` \n  - `needsApproval()`\n  - `isOrganizationInUserHierarchy()`\n\n### Phase 2: Transfer Request Server Actions (Priority: High)\n- [ ] `createTransferRequest(studentIds, targetOrg, reason)`\n  - Auto-approve if `needsApproval() === false`\n  - Create pending request if needs approval\n  - Update notification badge for target admin\n- [ ] `approveTransferRequest(requestId, notes)`\n  - Validate reviewer has authority\n  - Execute transfer (update `student.daerah_id`, etc.)\n  - Update `student.transfer_history`\n  - Clear notification badge\n- [ ] `rejectTransferRequest(requestId, notes)`\n  - Mark as rejected\n  - Clear notification badge\n  - Allow re-submission\n- [ ] `cancelTransferRequest(requestId)`\n  - Requester can cancel pending requests\n- [ ] `getPendingTransferRequests(userId)`\n  - Get requests awaiting user's review\n- [ ] `getMyTransferRequests(userId)`\n  - Get requests created by user\n\n### Phase 3: Archive \u0026 Delete Actions (Priority: High)\n- [ ] `archiveStudent(studentId, status: 'graduated'|'inactive', notes)`\n- [ ] `unarchiveStudent(studentId)`\n- [ ] `softDeleteStudent(studentId)` (update existing)\n- [ ] `restoreStudent(studentId)`\n- [ ] `hardDeleteStudent(studentId, confirmToken)` (superadmin only)\n\n### Phase 4: UI Components (Priority: Medium)\n- [ ] `TransferRequestModal` (NEW)\n  - Select destination (no restrictions on dropdown)\n  - Bulk student selection\n  - Reason field (required if cross-boundary)\n  - Preview: \"Auto-approved\" vs \"Needs approval from X\"\n- [ ] `PendingTransferRequestsSection` (NEW)\n  - List requests awaiting review\n  - Approve/Reject buttons\n  - Show student details, reason, requester\n- [ ] `TransferRequestHistoryModal` (NEW)\n  - Show request status (pending/approved/rejected)\n  - Timeline view\n- [ ] `NotificationBadge` (NEW)\n  - Show count of pending requests\n  - Click ‚Üí navigate to requests section\n- [ ] `ArchiveStudentModal`\n  - Status selector (graduated/inactive)\n  - Notes field\n- [ ] Update `DeleteStudentModal`\n  - Soft delete confirmation\n- [ ] `HardDeleteConfirmDialog`\n  - Superadmin only\n  - Type DELETE confirmation\n\n### Phase 5: Notification System (Priority: Medium)\n- [ ] In-app notification badge (no email)\n- [ ] Update `profiles.notification_badge` on request creation\n- [ ] Clear badge on request review\n- [ ] Real-time updates with Supabase Realtime (optional)\n\n### Phase 6: Testing (Priority: High)\n- [ ] Unit tests for permission utilities ‚úÖ DONE (38 tests)\n  - `canArchiveStudent()` ‚úÖ\n  - `canTransferStudent()` ‚úÖ (need to update for new workflow)\n  - `canSoftDeleteStudent()` ‚úÖ\n  - `canHardDeleteStudent()` ‚úÖ\n- [ ] Unit tests for new approval functions\n  - `canRequestTransfer()`\n  - `canReviewTransferRequest()`\n  - `needsApproval()`\n- [ ] Integration tests\n  - Auto-approved transfer flow\n  - Approval-required transfer flow\n  - Bulk transfer (5 students at once)\n  - Rejection and re-submission\n  - Archive/unarchive\n  - Soft delete/restore\n  - Hard delete cascade\n\n---\n\n## üéØ Success Criteria\n\n‚úÖ Admin can request transfer to ANY organization (no dropdown restrictions)\n‚úÖ Transfers within same org are auto-approved (immediate)\n‚úÖ Cross-boundary transfers create pending request\n‚úÖ Target admin receives in-app notification badge\n‚úÖ Target admin can approve/reject with notes\n‚úÖ Rejected requests can be re-submitted\n‚úÖ Bulk transfer (multiple students) in single request\n‚úÖ No expiration on pending requests\n‚úÖ Archived students hidden from active lists\n‚úÖ Soft deleted students can be restored\n‚úÖ Hard delete requires superadmin + double confirmation\n‚úÖ Full audit trail in `transfer_requests` and `transfer_history`\n\n---\n\n## üö® Edge Cases\n\n1. **Student already has pending transfer** ‚Üí Show warning, allow cancel old request\n2. **Request for deleted student** ‚Üí Not allowed, must restore first\n3. **Reviewer deletes their account** ‚Üí Request stays pending, other admins at same level can review\n4. **Student enrolled in multiple classes** ‚Üí Transfer updates org but keeps class enrollments (admin must manually update)\n5. **Bulk transfer with mix of statuses** ‚Üí Show which will auto-approve vs need approval\n6. **Requester cancels after reviewer approves** ‚Üí Cannot cancel approved requests\n7. **Destination org gets deleted** ‚Üí Request auto-cancelled with notification\n\n---\n\n## üìä Database Queries Examples\n\n### Get pending requests for reviewer\n```sql\n-- Admin Desa viewing requests targeting their desa\nSELECT tr.*, \n       array_agg(s.full_name) as student_names,\n       p.full_name as requester_name\nFROM transfer_requests tr\nJOIN profiles p ON tr.requested_by = p.id\nJOIN students s ON s.id = ANY(tr.student_ids)\nWHERE tr.status = 'pending'\n  AND tr.to_desa_id = :user_desa_id\n  AND (:user_role = 'superadmin' OR tr.to_daerah_id = :user_daerah_id)\nGROUP BY tr.id, p.full_name\nORDER BY tr.requested_at DESC;\n```\n\n### Update notification badge\n```sql\n-- Count pending requests for user's org\nUPDATE profiles\nSET notification_badge = jsonb_set(\n  notification_badge,\n  '{pending_transfer_requests}',\n  to_jsonb((\n    SELECT COUNT(*)\n    FROM transfer_requests\n    WHERE status = 'pending'\n      AND to_desa_id = :user_desa_id\n  ))\n)\nWHERE id = :user_id;\n```\n\n---\n\n## üîó Related Beads\n\n- Depends on: Database schema design\n- Blocks: UI implementation\n- Related: User permissions management\n\n---\n\n## üìù Notes\n\n- **Breaking change** from original plan: Transfer boundaries are now request-based, not hard restrictions\n- Existing `canTransferStudent()` tests need update to new `canRequestTransfer()` logic\n- Consider adding `transfer_requests_history` table for long-term audit (archive old completed/rejected requests)\n- Future: Add batch approval (approve 10 requests at once)\n- Future: Add delegation (admin can delegate approval authority to another admin)","notes":"## Phase 3 Progress Update (2026-02-11)\n\n### ‚úÖ Completed UI Components:\n- ArchiveStudentModal\n- TransferRequestModal  \n- PendingTransferRequestsSection\n- NotificationBadge\n- Unarchive feature (bonus)\n\n### ‚ùå Remaining Tasks:\n1. TransferRequestHistoryModal (audit trail)\n2. HardDeleteConfirmDialog (safety measure)\n3. Integration tests for transfer workflow\n\n---\n\n## üêõ Bugs \u0026 Issues Found (User Feedback):\n\n### Bug 1: Transfer Modal - Incorrect Org Filtering\n**Reported by**: Admin Kelompok Brangsong\n**Issue**: \n- Daerah dropdown only shows user's daerah (Kendal)\n- ‚ùå EXPECTED: Show ALL daerah in system\n- Desa dropdown ‚úÖ correct (shows all desa in selected daerah)\n- Kelompok dropdown only shows user's kelompok\n- ‚ùå EXPECTED: Show all kelompok in selected desa\n\n**Root Cause**: TransferRequestModal filtering org lists by user's hierarchy instead of showing all orgs\n**Fix Required**: Remove user hierarchy filter from daerah/kelompok lists in TransferRequestModal\n\n### Bug 2: Laporan Page - Multi-Kelompok Filter Issue\n**Issue**: When user selects multiple kelompok then selects class, kelompok filter gets cleared\n**Impact**: Cannot generate reports for multiple kelompok at once\n**Related File**: src/app/(admin)/laporan/page.tsx or components\n**See**: New issue sm-XXX (Laporan multi-kelompok filter bug)\n\n---\n\n## üéØ Feature Requests (User Feedback):\n\n### FR1: Teacher Transfer Permission\n**Request**: Role \"teacher\" should also have access to Transfer feature (like admin)\n**Current**: Only admin/superadmin can transfer\n**Desired**: Teacher with `permissions.can_transfer_students = true` can use Transfer feature\n**Implementation**:\n- Update TransferRequestModal to show for teachers with permission\n- Update page.tsx to pass onTransfer to table for teachers\n- Permission check already exists in `canRequestTransfer()`\n\n### FR2: Hide \"Permintaan Transfer\" Tab When Empty\n**Request**: Tab should only appear when there are pending requests\n**Current**: Tab always visible for admin (even when 0 requests)\n**Desired**: `{pendingRequests.length \u003e 0 \u0026\u0026 \u003cTab\u003e...}`\n**Impact**: Cleaner UI, less clutter\n\n### FR3: Move Status Filter to DataFilter Component\n**Request**: Centralize status filter in DataFilter.tsx for reuse\n**Current**: Status filter is inline in siswa/page.tsx\n**Desired**: \n- Add `showStatus?: boolean` prop to DataFilter\n- Move dropdown to DataFilter.tsx\n- Update CLAUDE.md with guideline: \"If filter will be reused, add to DataFilter.tsx\"\n**Benefits**: Consistency, reusability (can use in Guru, Laporan, etc.)\n\n### FR4: Teacher Permission Management UI\n**Request**: Add permission toggles in /users/guru page\n**Current**: No UI to grant permissions to teachers\n**Desired**: Checkboxes for:\n- ‚òê Can Archive Students\n- ‚òê Can Transfer Students  \n- ‚òê Can Soft Delete Students\n- ‚òê Can Hard Delete Students (superadmin only)\n**Implementation**: Update GuruModal or add PermissionsModal\n\n---\n\n## üìù Related New Issues:\n\n1. **sm-XXX**: Teacher roles for Desa and Daerah levels (like Kelompok)\n   - Allow creating teachers at desa/daerah level\n   - Configurable permissions per teacher level\n   - Access scoping based on hierarchy\n\n2. **sm-XXX**: Laporan page multi-kelompok filter bug\n   - Kelompok filter clears when class is selected\n   - Prevents multi-kelompok reports\n\n---\n\n## Next Steps:\n1. Fix Bug 1 (transfer modal org filtering) - HIGH PRIORITY\n2. Implement FR1 (teacher transfer permission) - HIGH PRIORITY  \n3. Implement FR2 (hide empty tab) - QUICK WIN\n4. Fix Bug 2 (laporan filter) or create separate issue\n5. Implement FR3 (centralize status filter) - MEDIUM\n6. Implement FR4 (teacher permissions UI) - MEDIUM\n7. Complete remaining Phase 3 tasks (history modal, hard delete confirm)\n8. Integration tests","priority":1,"issue_type":"feature","created_at":"2026-02-04T21:17:45.025032+07:00","created_by":"abuabdirohman","updated_at":"2026-02-11T15:17:07.930722+07:00","closed_at":"2026-02-11T15:17:07.930722+07:00","close_reason":"Core features complete: ‚úÖ Archive (graduated/inactive status), ‚úÖ Transfer with approval-based workflow (auto-approve same org, pending for cross-boundary), ‚úÖ Unarchive. Permission logic tested (66 tests, 100% coverage). Server actions implemented. UI components added (Archive/Transfer/Unarchive modals). Remaining enhancements moved to new issues (cancel request, mass transfer, hard delete, history)."}
{"id":"sm-qrt","status":"closed","title":"Setup unit testing infrastructure with Vitest","priority":2,"issue_type":"task","created_at":"2026-02-10T08:32:08.430507+07:00","created_by":"abuabdirohman","updated_at":"2026-02-10T11:42:52.429613+07:00","closed_at":"2026-02-10T11:42:52.429613+07:00","close_reason":"‚úÖ Setup complete! Vitest infrastructure ready with:\n- Dependencies installed (vitest, @testing-library, jsdom, coverage-v8)\n- Config files created (vitest.config.ts, test/setup.ts)\n- Supabase mock utilities (test/mocks/supabase.ts)\n- NPM scripts (test, test:run, test:ui, test:coverage)\n- TypeScript types configured\n- Example tests: classHelpers (15 tests, 100% coverage), batchFetching (6 tests, 100% coverage)\n- All tests passing (21/21 ‚úì)"}
{"id":"sm-x9a","status":"closed","title":"Enhancement: Show kelompok name in class label for desa-level users in AssignStudentsModal","description":"\n## Problem\nWhen desa-level admin users assign students to classes in AssignStudentsModal, the class dropdown only shows class names without kelompok information. This makes it difficult to identify which kelompok each class belongs to, especially when multiple kelompoks have classes with the same name.\n\n## Location\nFile: src/app/(admin)/users/siswa/components/AssignStudentsModal.tsx\nLine: 165\nCurrent code:\n```typescript\nlabel: cls.name,\n```\n\n## Expected Behavior\nFor desa-level users (admin_desa), the class label should include kelompok name:\n- Format: \"{kelompok_name} - {class_name}\"\n- Example: \"Kelompok A - Pra Nikah\" instead of just \"Pra Nikah\"\n\nFor other user levels (superadmin, admin_daerah, admin_kelompok, teacher):\n- Keep current behavior (class name only)\n\n## Implementation Notes\n1. Check user profile level (isAdminDesa from @/lib/userUtils)\n2. Ensure classes data includes kelompok relation\n3. Update label conditionally based on user level\n4. Test with desa-level admin account\n","priority":2,"issue_type":"task","created_at":"2026-02-04T20:21:10.443129+07:00","created_by":"abuabdirohman","updated_at":"2026-02-04T20:35:08.245938+07:00","closed_at":"2026-02-04T20:35:08.245938+07:00","close_reason":"Implemented conditional label for class dropdown. For admin_desa users, label shows 'Kelompok Name - Class Name', for other users shows 'Class Name' only."}
