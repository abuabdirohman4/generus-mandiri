{"id":"sm-04g","title":"Bug: Filter halaman organisasi tidak berjalan","description":"## üêõ Problem\nFilter pada halaman organisasi tidak berfungsi dengan baik.\n\n## üìç Location\nHalaman: /organisasi\n\n## üîç Expected Behavior\nFilter seharusnya dapat menyaring data organisasi berdasarkan kriteria yang dipilih (Daerah, Desa, Kelompok).\n\n## ‚ùå Current Behavior\nFilter tidak berjalan/tidak memberikan hasil yang diharapkan.\n\n## üß™ Steps to Reproduce\n1. Buka halaman Organisasi\n2. Coba gunakan filter (Daerah/Desa/Kelompok)\n3. Observe: Filter tidak bekerja\n\n## üîß Possible Causes\n- Filter logic tidak terhubung dengan data fetching\n- State management untuk filter tidak ter-update\n- Query parameters tidak ter-apply ke API call\n- RLS policy issue\n\n## üí° Investigation Needed\n- [ ] Check filter state management (Zustand/React state)\n- [ ] Verify API calls include filter parameters\n- [ ] Test filter with different organizational levels\n- [ ] Check console for errors\n- [ ] Review RLS policies for organisasi tables\n\n## üìù Related Files\n- src/app/(admin)/organisasi/page.tsx\n- src/app/(admin)/organisasi/components/\n- src/app/(admin)/organisasi/hooks/\n- src/app/(admin)/organisasi/stores/\n\n## üè∑Ô∏è Version\nv1.10.2","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-10T08:22:13.344661+07:00","created_by":"abuabdirohman","updated_at":"2026-01-10T08:22:13.344661+07:00","labels":["bug","filter","organisasi","ui"]}
{"id":"sm-37l","title":"Document unit testing strategy in CLAUDE.md","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-10T08:32:10.403811+07:00","created_by":"abuabdirohman","updated_at":"2026-02-10T10:25:16.505951+07:00","closed_at":"2026-02-10T10:25:16.505951+07:00","close_reason":"Completed comprehensive unit testing documentation in CLAUDE.md. Includes: testing stack (Vitest), priority strategy, setup instructions, example tests, coverage goals, and 3-phase roadmap.","dependencies":[{"issue_id":"sm-37l","depends_on_id":"sm-qrt","type":"blocks","created_at":"2026-02-10T08:32:49.584523+07:00","created_by":"abuabdirohman"}]}
{"id":"sm-6gn","title":"Write tests for utility functions (Priority 1)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-10T08:32:12.306887+07:00","created_by":"abuabdirohman","updated_at":"2026-02-10T12:41:01.656665+07:00","closed_at":"2026-02-10T12:41:01.656665+07:00","close_reason":"‚úÖ Phase 2 Complete! All Priority 1 utilities tested with 60/60 tests passing.\n\nCoverage achieved:\n- accessControlServer.ts: 69% statements, 100% branches, 80% functions\n- attendanceCalculation.ts: 68% statements, 100% branches, 83% functions  \n- userUtils.ts: 100% statements, 87.5% branches, 100% functions\n- utils.ts: 91% statements, 64% branches, 87.5% functions\n- classHelpers.ts: 100% coverage (Phase 1)\n- batchFetching.ts: 100% coverage (Phase 1)\n\nTest files created:\n- src/lib/__tests__/accessControlServer.test.ts (14 tests)\n- src/lib/utils/__tests__/attendanceCalculation.test.ts (12 tests)\n- src/lib/__tests__/userUtils.test.ts (5 tests)\n- src/lib/__tests__/utils.test.ts (8 tests)\n\nAverage coverage: ~88% across all Priority 1 utilities. Exceeded target of 70-80%!","dependencies":[{"issue_id":"sm-6gn","depends_on_id":"sm-qrt","type":"blocks","created_at":"2026-02-10T08:32:58.235922+07:00","created_by":"abuabdirohman"}]}
{"id":"sm-8yf","title":"Feature: Student management actions (Archive, Transfer, Soft Delete, Hard Delete) with teacher permissions","description":"## Overview\nImplement student lifecycle management with approval-based transfer workflow. Students can be archived (graduated/inactive), transferred with approval system, and deleted (soft/hard) with role-based permissions.\n\n## üéØ Key Features\n\n### 1. Archive Student (with Status)\n**No approval needed** - Immediate action\n\n### 2. **Transfer Student (Approval-Based Workflow)** ‚≠ê NEW APPROACH\n**Cross-boundary transfers allowed with approval system**\n\n### 3. Soft Delete (Restorable)\n**No approval needed** - Immediate action\n\n### 4. Hard Delete (Permanent)\n**Superadmin only** - No approval needed\n\n---\n\n## üîÑ Transfer Workflow (Approval-Based System)\n\n### Core Principles:\n1. ‚úÖ **Can request transfer anywhere** (no hard boundaries)\n2. ‚úÖ **Auto-approved if within same organization scope**\n3. ‚úÖ **Needs approval if crossing organizational boundaries**\n4. ‚úÖ **Reviewer must have authority over destination organization**\n5. ‚úÖ **Support bulk transfers** (multiple students in one request)\n\n### Transfer Rules:\n\n| Scenario | Auto-Approved? | Reviewer Needed? |\n|----------|---------------|------------------|\n| Same Kelompok (class change only) | ‚úÖ Yes | ‚ùå No |\n| Different Kelompok, Same Desa | ‚úÖ Yes | ‚ùå No |\n| Different Desa, Same Daerah | ‚ùå No | ‚úÖ Admin Desa (target) |\n| Different Daerah | ‚ùå No | ‚úÖ Admin Daerah (target) |\n| Superadmin transfer | ‚úÖ Yes (bypass) | ‚ùå No |\n\n### Request Status Flow:\n```\n[Created] ‚Üí pending\n    ‚Üì\n    ‚îú‚îÄ‚Üí Auto-approved (same org) ‚Üí approved ‚Üí executed\n    ‚îÇ\n    ‚îî‚îÄ‚Üí Needs approval (cross-boundary) ‚Üí pending\n            ‚Üì\n            ‚îú‚îÄ‚Üí [Reviewer: Approve] ‚Üí approved ‚Üí executed\n            ‚îÇ\n            ‚îú‚îÄ‚Üí [Reviewer: Reject] ‚Üí rejected (can re-submit)\n            ‚îÇ\n            ‚îî‚îÄ‚Üí [Requester: Cancel] ‚Üí cancelled\n```\n\n---\n\n## üóÑÔ∏è Database Schema\n\n### New Table: transfer_requests\n```sql\nCREATE TABLE transfer_requests (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  \n  -- Students being transferred (supports bulk)\n  student_ids UUID[] NOT NULL, -- Array of student IDs\n  \n  -- Source organization (current)\n  from_daerah_id UUID REFERENCES daerah(id),\n  from_desa_id UUID REFERENCES desa(id),\n  from_kelompok_id UUID REFERENCES kelompok(id),\n  \n  -- Destination organization (target)\n  to_daerah_id UUID REFERENCES daerah(id),\n  to_desa_id UUID REFERENCES desa(id),\n  to_kelompok_id UUID REFERENCES kelompok(id),\n  to_class_ids UUID[], -- Optional: specific classes to assign\n  \n  -- Request metadata\n  requested_by UUID REFERENCES profiles(id) NOT NULL,\n  requested_at TIMESTAMPTZ DEFAULT NOW(),\n  reason TEXT, -- Required for cross-boundary transfers\n  notes TEXT,\n  \n  -- Approval workflow\n  status VARCHAR(20) DEFAULT 'pending' \n    CHECK (status IN ('pending', 'approved', 'rejected', 'cancelled')),\n  \n  reviewed_by UUID REFERENCES profiles(id),\n  reviewed_at TIMESTAMPTZ,\n  review_notes TEXT,\n  \n  -- Execution\n  executed_at TIMESTAMPTZ,\n  executed_by UUID REFERENCES profiles(id),\n  \n  -- Audit\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\nCREATE INDEX idx_transfer_requests_status ON transfer_requests(status);\nCREATE INDEX idx_transfer_requests_students ON transfer_requests USING GIN(student_ids);\nCREATE INDEX idx_transfer_pending_target ON transfer_requests(to_daerah_id, to_desa_id, to_kelompok_id) \n  WHERE status = 'pending';\nCREATE INDEX idx_transfer_requester ON transfer_requests(requested_by);\n```\n\n### Update: students table\n```sql\nALTER TABLE students\n  ADD COLUMN status VARCHAR(20) DEFAULT 'active'\n    CHECK (status IN ('active', 'graduated', 'inactive')),\n  ADD COLUMN archived_at TIMESTAMPTZ,\n  ADD COLUMN archived_by UUID REFERENCES profiles(id),\n  ADD COLUMN archive_notes TEXT,\n  ADD COLUMN transfer_history JSONB DEFAULT '[]'::jsonb;\n  -- deleted_at already exists\n\nCREATE INDEX idx_students_status ON students(status);\nCREATE INDEX idx_students_archived ON students(archived_at) WHERE archived_at IS NOT NULL;\n```\n\n### Update: profiles table\n```sql\nALTER TABLE profiles\n  ADD COLUMN permissions JSONB DEFAULT '{\n    \"can_archive_students\": false,\n    \"can_transfer_students\": false,\n    \"can_soft_delete_students\": false\n  }'::jsonb,\n  ADD COLUMN notification_badge JSONB DEFAULT '{\n    \"pending_transfer_requests\": 0\n  }'::jsonb;\n\nCREATE INDEX idx_profiles_permissions ON profiles USING GIN(permissions);\n```\n\n---\n\n## üìã Implementation Tasks\n\n### Phase 1: Database \u0026 Permissions (Priority: High)\n- [ ] Migration: `transfer_requests` table\n- [ ] Migration: `students` status fields\n- [ ] Migration: `profiles.permissions` JSONB\n- [ ] RLS policies for `transfer_requests`\n- [ ] **TDD**: Write tests for permission utilities ‚úÖ DONE\n  - `canRequestTransfer()` ‚úÖ\n  - `canReviewTransferRequest()` \n  - `needsApproval()`\n  - `isOrganizationInUserHierarchy()`\n\n### Phase 2: Transfer Request Server Actions (Priority: High)\n- [ ] `createTransferRequest(studentIds, targetOrg, reason)`\n  - Auto-approve if `needsApproval() === false`\n  - Create pending request if needs approval\n  - Update notification badge for target admin\n- [ ] `approveTransferRequest(requestId, notes)`\n  - Validate reviewer has authority\n  - Execute transfer (update `student.daerah_id`, etc.)\n  - Update `student.transfer_history`\n  - Clear notification badge\n- [ ] `rejectTransferRequest(requestId, notes)`\n  - Mark as rejected\n  - Clear notification badge\n  - Allow re-submission\n- [ ] `cancelTransferRequest(requestId)`\n  - Requester can cancel pending requests\n- [ ] `getPendingTransferRequests(userId)`\n  - Get requests awaiting user's review\n- [ ] `getMyTransferRequests(userId)`\n  - Get requests created by user\n\n### Phase 3: Archive \u0026 Delete Actions (Priority: High)\n- [ ] `archiveStudent(studentId, status: 'graduated'|'inactive', notes)`\n- [ ] `unarchiveStudent(studentId)`\n- [ ] `softDeleteStudent(studentId)` (update existing)\n- [ ] `restoreStudent(studentId)`\n- [ ] `hardDeleteStudent(studentId, confirmToken)` (superadmin only)\n\n### Phase 4: UI Components (Priority: Medium)\n- [ ] `TransferRequestModal` (NEW)\n  - Select destination (no restrictions on dropdown)\n  - Bulk student selection\n  - Reason field (required if cross-boundary)\n  - Preview: \"Auto-approved\" vs \"Needs approval from X\"\n- [ ] `PendingTransferRequestsSection` (NEW)\n  - List requests awaiting review\n  - Approve/Reject buttons\n  - Show student details, reason, requester\n- [ ] `TransferRequestHistoryModal` (NEW)\n  - Show request status (pending/approved/rejected)\n  - Timeline view\n- [ ] `NotificationBadge` (NEW)\n  - Show count of pending requests\n  - Click ‚Üí navigate to requests section\n- [ ] `ArchiveStudentModal`\n  - Status selector (graduated/inactive)\n  - Notes field\n- [ ] Update `DeleteStudentModal`\n  - Soft delete confirmation\n- [ ] `HardDeleteConfirmDialog`\n  - Superadmin only\n  - Type DELETE confirmation\n\n### Phase 5: Notification System (Priority: Medium)\n- [ ] In-app notification badge (no email)\n- [ ] Update `profiles.notification_badge` on request creation\n- [ ] Clear badge on request review\n- [ ] Real-time updates with Supabase Realtime (optional)\n\n### Phase 6: Testing (Priority: High)\n- [ ] Unit tests for permission utilities ‚úÖ DONE (38 tests)\n  - `canArchiveStudent()` ‚úÖ\n  - `canTransferStudent()` ‚úÖ (need to update for new workflow)\n  - `canSoftDeleteStudent()` ‚úÖ\n  - `canHardDeleteStudent()` ‚úÖ\n- [ ] Unit tests for new approval functions\n  - `canRequestTransfer()`\n  - `canReviewTransferRequest()`\n  - `needsApproval()`\n- [ ] Integration tests\n  - Auto-approved transfer flow\n  - Approval-required transfer flow\n  - Bulk transfer (5 students at once)\n  - Rejection and re-submission\n  - Archive/unarchive\n  - Soft delete/restore\n  - Hard delete cascade\n\n---\n\n## üéØ Success Criteria\n\n‚úÖ Admin can request transfer to ANY organization (no dropdown restrictions)\n‚úÖ Transfers within same org are auto-approved (immediate)\n‚úÖ Cross-boundary transfers create pending request\n‚úÖ Target admin receives in-app notification badge\n‚úÖ Target admin can approve/reject with notes\n‚úÖ Rejected requests can be re-submitted\n‚úÖ Bulk transfer (multiple students) in single request\n‚úÖ No expiration on pending requests\n‚úÖ Archived students hidden from active lists\n‚úÖ Soft deleted students can be restored\n‚úÖ Hard delete requires superadmin + double confirmation\n‚úÖ Full audit trail in `transfer_requests` and `transfer_history`\n\n---\n\n## üö® Edge Cases\n\n1. **Student already has pending transfer** ‚Üí Show warning, allow cancel old request\n2. **Request for deleted student** ‚Üí Not allowed, must restore first\n3. **Reviewer deletes their account** ‚Üí Request stays pending, other admins at same level can review\n4. **Student enrolled in multiple classes** ‚Üí Transfer updates org but keeps class enrollments (admin must manually update)\n5. **Bulk transfer with mix of statuses** ‚Üí Show which will auto-approve vs need approval\n6. **Requester cancels after reviewer approves** ‚Üí Cannot cancel approved requests\n7. **Destination org gets deleted** ‚Üí Request auto-cancelled with notification\n\n---\n\n## üìä Database Queries Examples\n\n### Get pending requests for reviewer\n```sql\n-- Admin Desa viewing requests targeting their desa\nSELECT tr.*, \n       array_agg(s.full_name) as student_names,\n       p.full_name as requester_name\nFROM transfer_requests tr\nJOIN profiles p ON tr.requested_by = p.id\nJOIN students s ON s.id = ANY(tr.student_ids)\nWHERE tr.status = 'pending'\n  AND tr.to_desa_id = :user_desa_id\n  AND (:user_role = 'superadmin' OR tr.to_daerah_id = :user_daerah_id)\nGROUP BY tr.id, p.full_name\nORDER BY tr.requested_at DESC;\n```\n\n### Update notification badge\n```sql\n-- Count pending requests for user's org\nUPDATE profiles\nSET notification_badge = jsonb_set(\n  notification_badge,\n  '{pending_transfer_requests}',\n  to_jsonb((\n    SELECT COUNT(*)\n    FROM transfer_requests\n    WHERE status = 'pending'\n      AND to_desa_id = :user_desa_id\n  ))\n)\nWHERE id = :user_id;\n```\n\n---\n\n## üîó Related Beads\n\n- Depends on: Database schema design\n- Blocks: UI implementation\n- Related: User permissions management\n\n---\n\n## üìù Notes\n\n- **Breaking change** from original plan: Transfer boundaries are now request-based, not hard restrictions\n- Existing `canTransferStudent()` tests need update to new `canRequestTransfer()` logic\n- Consider adding `transfer_requests_history` table for long-term audit (archive old completed/rejected requests)\n- Future: Add batch approval (approve 10 requests at once)\n- Future: Add delegation (admin can delegate approval authority to another admin)","notes":"‚úÖ **Phase 1 \u0026 2 COMPLETED**\n\n## Phase 1: Database Schema Migration ‚úÖ\n- **Status**: Applied successfully on 2026-02-11\n- **Migration ID**: `student_management_schema`\n- **File**: `supabase/migrations/20260211_student_management_schema.sql`\n\n### Schema Changes Applied:\n1. ‚úÖ **transfer_requests** table created (0 rows)\n2. ‚úÖ **students** table updated (401 rows with new columns)\n3. ‚úÖ **profiles** table updated (37 rows with permissions/notifications)\n4. ‚úÖ Helper functions \u0026 triggers installed\n5. ‚úÖ RLS policies active\n\n---\n\n## Phase 2: Server Actions ‚úÖ\n- **Status**: Already implemented\n- **File**: `src/app/(admin)/users/siswa/actions/management.ts`\n\n### Implemented Actions:\n\n#### Archive/Unarchive ‚úÖ\n- `archiveStudent(input)` - Mark as graduated/inactive\n- `unarchiveStudent(studentId)` - Restore to active\n\n#### Transfer Request Workflow ‚úÖ\n- `createTransferRequest(input)` - Create request with auto-approval logic\n- `approveTransferRequest(requestId, notes)` - Approve and execute\n- `rejectTransferRequest(requestId, notes)` - Reject request\n- `cancelTransferRequest(requestId)` - Requester cancels pending\n- `getPendingTransferRequests()` - Get requests to review\n- `getMyTransferRequests()` - Get requests created by user\n- `executeTransfer(requestId, executorId)` - Internal helper for execution\n\n#### Delete/Restore ‚úÖ\n- `deleteStudent(studentId, permanent)` - Soft/hard delete (in actions.ts)\n- `restoreStudent(studentId)` - Restore soft deleted\n\n### Key Features Implemented:\n‚úÖ Auto-approval for same-org transfers\n‚úÖ Bulk transfer support (multiple students)\n‚úÖ Permission checks using `studentPermissions.ts`\n‚úÖ Transfer history tracking (JSONB array)\n‚úÖ Class assignment updates on transfer\n‚úÖ Notification badge updates (via DB triggers)\n‚úÖ RLS policy enforcement\n‚úÖ Proper error handling\n\n---\n\n## Phase 3: UI Components (TODO)\n- [ ] TransferRequestModal\n- [ ] PendingTransferRequestsSection\n- [ ] TransferRequestHistoryModal\n- [ ] NotificationBadge\n- [ ] ArchiveStudentModal\n- [ ] Update DeleteStudentModal\n- [ ] HardDeleteConfirmDialog\n\n---\n\n## Phase 4: Testing (Partially Done)\n‚úÖ Permission utilities (66 tests, 100% coverage)\n- [ ] Integration tests for transfer workflow\n- [ ] E2E tests for UI flows\n\n---\n\n## Summary\n\n**Completed**:\n- ‚úÖ Database schema migration\n- ‚úÖ Permission logic (TDD with 66 tests)\n- ‚úÖ All server actions for Phase 2\n\n**Remaining**:\n- [ ] UI components (Phase 3)\n- [ ] Integration tests (Phase 4)\n\n**Next Step**: Implement UI components untuk transfer workflow dan student management.","status":"in_progress","priority":1,"issue_type":"feature","created_at":"2026-02-04T21:17:45.025032+07:00","created_by":"abuabdirohman","updated_at":"2026-02-11T10:11:19.399559+07:00"}
{"id":"sm-8yt","title":"Bug: DataFilter layout for 3 filters not aligned properly for admin desa","description":"\n## Problem\nWhen admin_desa users view pages with DataFilter showing 3 filters (e.g., Kelompok, Kelas, Jenis Kelamin), the layout is not properly aligned. The filters appear in different rows with inconsistent widths.\n\n## Current Behavior\n- All 3 filters appear on separate rows\n- Filter widths are not equal\n- Layout looks messy and unprofessional\n\n## Expected Behavior\n- 2 filters on top row (equal width)\n- 1 filter on bottom row (full width on mobile, equal width on desktop)\n- All filters should be aligned and have consistent spacing\n\n## Location\nFile: src/components/shared/DataFilter.tsx\nLines: 570-598\n\n## Current Code Issue\nLine 576 uses `grid-cols-2 md:grid-cols-4` for filterCount 2-4, which doesn't handle 3 filters properly.\nThe `getFilterClass` function attempts to fix this with col-span, but the base grid is incorrect.\n\n## Attempted Fix (Reverted)\nChanged line 576 to separate cases:\n- filterCount === 2: grid-cols-2 md:grid-cols-4\n- filterCount === 3: grid-cols-2 md:grid-cols-3\n- filterCount === 4: grid-cols-2 md:grid-cols-4\n\nBut this was reverted by linter/prettier.\n\n## Solution Needed\nNeed to implement proper grid layout for 3 filters that:\n1. Works on mobile (2 cols, last spans 2)\n2. Works on desktop (3 equal cols)\n3. Survives linter/prettier formatting\n","status":"open","priority":2,"issue_type":"bug","created_at":"2026-02-04T21:16:35.534343+07:00","created_by":"abuabdirohman","updated_at":"2026-02-04T21:16:35.534343+07:00"}
{"id":"sm-a0y","title":"Refactor: Optimize absensi/actions.ts (2215 ‚Üí ~900 lines)","description":"Mengurangi kompleksitas dan duplikasi kode di src/app/(admin)/absensi/actions.ts dengan memecah logika berulang menjadi utility functions yang reusable.\n\n## üéØ Objectives\n- Reduce from 2215 lines to ~900 lines (-59%)\n- Eliminate ~1300 lines of duplicated code (-96%)\n- Split getMeetingsWithStats (986 lines ‚Üí ~200 lines per function)\n- Improve testability and maintainability\n\n## üìä Problem Analysis\n\n### Duplicated Code Identified:\n1. **Data Transformation Logic** (~360 lines duplicate)\n   - Transform array to object (kelompok/desa/daerah): 12x repetitions\n   - Build class names array: 6x repetitions\n   - Build allClasses array: 4x repetitions\n\n2. **Filter Logic** (~200 lines duplicate)\n   - Teacher class filtering: 3x repetitions\n   - Admin hierarchy filtering: 3x repetitions\n   - Pengajar access logic: 4x repetitions\n\n3. **Stats Calculation** (~300 lines duplicate)\n   - Attendance percentage calculation: 3x repetitions\n   - Student filtering by role: 3x repetitions\n   - Stats enrichment: 3x repetitions\n\n4. **Query Patterns** (~150 lines duplicate)\n   - Fetch classes with hierarchy: 6x repetitions\n   - Build class maps: 5x repetitions\n   - Fetch student-class mappings: 3x repetitions\n\n5. **Auth \u0026 Validation** (~100 lines duplicate)\n   - User + profile fetch: 8x repetitions\n   - Teacher class validation: 2x repetitions\n   - Student validation: 3x repetitions\n\n## üîß Implementation Phases\n\n### Phase 1: Extract Data Transformation Utilities (Reduction: ~310 lines)\n**Create:** src/lib/utils/dataTransformers.ts\n**Functions:**\n- transformClassWithHierarchy(classData)\n- transformMeetingClasses(meeting)\n- buildAllClassesArray(meeting, allClassesMap)\n- buildClassNamesArray(meeting, classNameMap)\n\n### Phase 2: Extract Query Helpers (Reduction: ~140 lines)\n**Create:** src/lib/utils/queryHelpers.ts\n**Functions:**\n- fetchClassesWithHierarchy(supabase, classIds)\n- buildClassMaps(classesData)\n- fetchStudentClassMappings(supabase, studentIds)\n\n### Phase 3: Extract Meeting Filter Logic (Reduction: ~340 lines)\n**Create:** src/app/(admin)/absensi/utils/meetingFilters.ts\n**Functions:**\n- filterMeetingsByTeacherClasses(meetings, teacherClassIds, ...)\n- filterMeetingsByAdminLevel(meetings, profile, ...)\n- checkPengajarAccess(meeting, teacherKelompokIds, classDetailsMap)\n\n### Phase 4: Extract Stats Calculation (Reduction: ~400 lines)\n**Create:** src/app/(admin)/absensi/utils/statsCalculators.ts\n**Functions:**\n- calculateMeetingStats(meeting, attendanceByMeeting, relevantStudentIds)\n- processRoleBasedStudentFilter(meeting, profile, ...)\n- enrichMeetingsWithStats(meetings, attendanceByMeeting, ...)\n\n### Phase 5: Extract Auth \u0026 Validation (Reduction: ~140 lines)\n**Create:** src/app/(admin)/absensi/utils/authHelpers.ts\n**Functions:**\n- getCurrentUserWithProfile(supabase, fields?)\n- validateTeacherClasses(adminClient, teacherId, classIds)\n- validateStudentSelection(adminClient, classIds, studentIds)\n\n### Phase 6: Split getMeetingsWithStats (Reduction: ~200 lines)\n**Create:** src/app/(admin)/absensi/utils/meetingQueries.ts\n**Structure:**\n- getMeetingsWithStats() - Main orchestrator (~100 lines)\n- getTeacherMeetingsWithStats() - Teacher-specific (~200 lines)\n- getAdminMeetingsWithStats() - Admin-specific (~180 lines)\n- getFallbackMeetingsWithStats() - Fallback (~100 lines)\n\n### Phase 7: Refactor actions.ts\n**Update all functions to use new utilities:**\n- createMeeting - Use authHelpers \u0026 validation\n- getMeetingById - Use dataTransformers\n- updateMeeting - Use authHelpers \u0026 validation\n- getMeetingsWithStats - Import from meetingQueries\n- getStudentsFromSnapshot - Use dataTransformers\n\n## üìÇ New File Structure\nsrc/lib/utils/\n‚îú‚îÄ‚îÄ dataTransformers.ts [NEW - ~150 lines]\n‚îú‚îÄ‚îÄ queryHelpers.ts [NEW - ~120 lines]\n\nsrc/app/(admin)/absensi/utils/\n‚îú‚îÄ‚îÄ authHelpers.ts [NEW - ~100 lines]\n‚îú‚îÄ‚îÄ meetingFilters.ts [NEW - ~200 lines]\n‚îú‚îÄ‚îÄ statsCalculators.ts [NEW - ~180 lines]\n‚îú‚îÄ‚îÄ meetingQueries.ts [NEW - ~150 lines]\n\nsrc/app/(admin)/absensi/\n‚îî‚îÄ‚îÄ actions.ts [REFACTORED - ~900 lines]\n\n**Total New Files:** 6\n**Total New LOC:** ~900 lines (reusable utilities)\n**Total Removed LOC:** ~1300 lines (duplications)\n**Net Reduction:** -400 lines + better modularity\n\n## ‚úÖ Acceptance Criteria\n- [ ] No duplicated logic (\u003c 50 lines duplication)\n- [ ] All functions \u003c 200 lines\n- [ ] All utilities have TypeScript interfaces\n- [ ] All utilities have JSDoc comments\n- [ ] All existing tests pass\n- [ ] Unit tests for new utility functions\n- [ ] No performance regression\n- [ ] Type checking passes (npm run type-check)\n- [ ] No new ESLint warnings\n- [ ] All public API signatures unchanged\n- [ ] Existing SWR hooks still work\n\n## üìä Success Metrics\n| Metric | Before | After | Target |\n|--------|--------|-------|--------|\n| Total LOC (actions.ts) | 2215 | ~900 | -59% |\n| Duplicated code | ~1300 | ~50 | -96% |\n| Longest function | 986 lines | ~200 lines | -80% |\n| Cyclomatic complexity | High | Low | ‚úÖ |\n| Utility files | 3 | 9 | Modular |\n\n## üîÑ Migration Strategy\n**Approach:** Incremental refactoring (backward compatible at each step)\n1. Phases 1-5: Create utilities without using them ‚Üí 0 risk\n2. Phase 6-7: Refactor one function at a time ‚Üí Test each change\n3. Each phase can be committed separately\n4. Rollback plan: Revert specific commit if issues arise\n\n## üß™ Testing Strategy\n**Unit Tests:** Test each utility function independently\n**Integration Tests:** All existing API tests must pass\n**Manual Testing:** Test with different user roles (teacher, admin, superadmin)\n\n## üêõ Known Risks \u0026 Mitigation\n**Risk 1:** Breaking existing functionality\n**Mitigation:** Keep all public APIs unchanged, test each phase\n\n**Risk 2:** Performance regression\n**Mitigation:** Measure query counts before/after, use same Supabase clients\n\n**Risk 3:** Type errors in complex transformations\n**Mitigation:** Strong typing for all utilities, unit tests for edge cases\n\n## üìÖ Timeline Estimate\n| Phase | Estimated Time | Risk Level |\n|-------|----------------|------------|\n| Phase 1 | 2 hours | Low |\n| Phase 2 | 1.5 hours | Low |\n| Phase 3 | 3 hours | Medium |\n| Phase 4 | 2.5 hours | Medium |\n| Phase 5 | 2 hours | Low |\n| Phase 6 | 3 hours | Medium |\n| Phase 7 | 4 hours | High |\n| Testing | 3 hours | - |\n| **Total** | **~21 hours** | **Medium** |\n\n## üìù Notes\n- This refactoring does NOT change any business logic\n- All RLS policies remain the same\n- Database queries are unchanged (only reorganized)\n- Existing SWR cache keys remain compatible\n- No changes to UI components needed\n\n## üîó Related Files\n**Files to Modify:**\n- src/app/(admin)/absensi/actions.ts\n\n**Files to Create:**\n- src/lib/utils/dataTransformers.ts\n- src/lib/utils/queryHelpers.ts\n- src/app/(admin)/absensi/utils/authHelpers.ts\n- src/app/(admin)/absensi/utils/meetingFilters.ts\n- src/app/(admin)/absensi/utils/statsCalculators.ts\n- src/app/(admin)/absensi/utils/meetingQueries.ts\n\n**Files to Reference:**\n- src/lib/utils/classHelpers.ts (existing patterns)\n- src/lib/utils/batchFetching.ts (existing patterns)\n- src/app/(admin)/laporan/actions.ts (similar complexity)\n\n## ‚ú® Future Improvements\nAfter this refactoring:\n1. Apply same patterns to laporan/actions.ts (~900 lines)\n2. Extract common attendance filtering to shared utilities\n3. Add performance monitoring/telemetry\n4. Implement request caching at server action level","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T07:42:57.808618+07:00","created_by":"abuabdirohman","updated_at":"2026-01-10T07:42:57.808618+07:00","labels":["absensi","code-quality","refactoring","technical-debt"]}
{"id":"sm-qrt","title":"Setup unit testing infrastructure with Vitest","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-10T08:32:08.430507+07:00","created_by":"abuabdirohman","updated_at":"2026-02-10T11:42:52.429613+07:00","closed_at":"2026-02-10T11:42:52.429613+07:00","close_reason":"‚úÖ Setup complete! Vitest infrastructure ready with:\n- Dependencies installed (vitest, @testing-library, jsdom, coverage-v8)\n- Config files created (vitest.config.ts, test/setup.ts)\n- Supabase mock utilities (test/mocks/supabase.ts)\n- NPM scripts (test, test:run, test:ui, test:coverage)\n- TypeScript types configured\n- Example tests: classHelpers (15 tests, 100% coverage), batchFetching (6 tests, 100% coverage)\n- All tests passing (21/21 ‚úì)"}
{"id":"sm-x9a","title":"Enhancement: Show kelompok name in class label for desa-level users in AssignStudentsModal","description":"\n## Problem\nWhen desa-level admin users assign students to classes in AssignStudentsModal, the class dropdown only shows class names without kelompok information. This makes it difficult to identify which kelompok each class belongs to, especially when multiple kelompoks have classes with the same name.\n\n## Location\nFile: src/app/(admin)/users/siswa/components/AssignStudentsModal.tsx\nLine: 165\nCurrent code:\n```typescript\nlabel: cls.name,\n```\n\n## Expected Behavior\nFor desa-level users (admin_desa), the class label should include kelompok name:\n- Format: \"{kelompok_name} - {class_name}\"\n- Example: \"Kelompok A - Pra Nikah\" instead of just \"Pra Nikah\"\n\nFor other user levels (superadmin, admin_daerah, admin_kelompok, teacher):\n- Keep current behavior (class name only)\n\n## Implementation Notes\n1. Check user profile level (isAdminDesa from @/lib/userUtils)\n2. Ensure classes data includes kelompok relation\n3. Update label conditionally based on user level\n4. Test with desa-level admin account\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T20:21:10.443129+07:00","created_by":"abuabdirohman","updated_at":"2026-02-04T20:35:08.245938+07:00","closed_at":"2026-02-04T20:35:08.245938+07:00","close_reason":"Implemented conditional label for class dropdown. For admin_desa users, label shows 'Kelompok Name - Class Name', for other users shows 'Class Name' only."}
