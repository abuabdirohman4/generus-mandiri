{"id":"sm-04g","title":"Bug: Filter halaman organisasi tidak berjalan","description":"## üêõ Problem\nFilter pada halaman organisasi tidak berfungsi dengan baik.\n\n## üìç Location\nHalaman: /organisasi\n\n## üîç Expected Behavior\nFilter seharusnya dapat menyaring data organisasi berdasarkan kriteria yang dipilih (Daerah, Desa, Kelompok).\n\n## ‚ùå Current Behavior\nFilter tidak berjalan/tidak memberikan hasil yang diharapkan.\n\n## üß™ Steps to Reproduce\n1. Buka halaman Organisasi\n2. Coba gunakan filter (Daerah/Desa/Kelompok)\n3. Observe: Filter tidak bekerja\n\n## üîß Possible Causes\n- Filter logic tidak terhubung dengan data fetching\n- State management untuk filter tidak ter-update\n- Query parameters tidak ter-apply ke API call\n- RLS policy issue\n\n## üí° Investigation Needed\n- [ ] Check filter state management (Zustand/React state)\n- [ ] Verify API calls include filter parameters\n- [ ] Test filter with different organizational levels\n- [ ] Check console for errors\n- [ ] Review RLS policies for organisasi tables\n\n## üìù Related Files\n- src/app/(admin)/organisasi/page.tsx\n- src/app/(admin)/organisasi/components/\n- src/app/(admin)/organisasi/hooks/\n- src/app/(admin)/organisasi/stores/\n\n## üè∑Ô∏è Version\nv1.10.2\n\nLabels: [bug filter organisasi ui]\n\n---\n\n**GitHub Issue**: https://github.com/abuabdirohman4/generus-mandiri/issues/5","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T08:22:13.344661+07:00","created_by":"abuabdirohman","updated_at":"2026-02-26T12:01:48.361565+07:00","closed_at":"2026-02-26T12:01:48.361565+07:00","close_reason":"Closed","labels":["bug","filter","organisasi","ui"]}
{"id":"sm-37l","title":"Document unit testing strategy in CLAUDE.md","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-10T08:32:10.403811+07:00","created_by":"abuabdirohman","updated_at":"2026-02-26T10:01:39.652457+07:00","closed_at":"2026-02-26T10:01:40.652457+07:00","close_reason":"Completed comprehensive unit testing documentation in CLAUDE.md. Includes: testing stack (Vitest), priority strategy, setup instructions, example tests, coverage goals, and 3-phase roadmap.","dependencies":[{"issue_id":"sm-37l","depends_on_id":"sm-qrt","type":"blocks","created_at":"2026-02-10T08:32:49.584523+07:00","created_by":"abuabdirohman"}],"deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"sm-3ud","title":"Fix Missing Data for Guru Desa/Daerah","description":"Fix missing data for Guru Desa/Daerah (hierarchical teachers). Root cause: Core data fetching functions only supported regular teachers with teacher_classes, not hierarchical teachers with organizational IDs. Phase 1 complete (7 files modified, 5 bugs fixed, 159/159 tests passing). Phase 2 pending: meeting detail page and CreateMeetingModal.","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-22T08:51:52.183326+07:00","created_by":"abuabdirohman","updated_at":"2026-02-26T10:01:39.652457+07:00","closed_at":"2026-02-26T10:01:40.652457+07:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"sm-4tl","title":"Update architecture docs with new pattern","status":"open","priority":4,"issue_type":"task","created_at":"2026-03-01T12:06:41.382462+07:00","created_by":"abuabdirohman","updated_at":"2026-03-01T12:06:41.382462+07:00","dependencies":[{"issue_id":"sm-4tl","depends_on_id":"sm-vpo","type":"blocks","created_at":"2026-03-01T12:07:08.745415+07:00","created_by":"abuabdirohman"},{"issue_id":"sm-4tl","depends_on_id":"sm-dsw","type":"blocks","created_at":"2026-03-01T12:07:09.150085+07:00","created_by":"abuabdirohman"},{"issue_id":"sm-4tl","depends_on_id":"sm-9o0","type":"blocks","created_at":"2026-03-01T12:07:09.512607+07:00","created_by":"abuabdirohman"},{"issue_id":"sm-4tl","depends_on_id":"sm-uk4","type":"blocks","created_at":"2026-03-01T12:07:09.855454+07:00","created_by":"abuabdirohman"}]}
{"id":"sm-4u0","title":"Fix: Filter not reset on logout causing stale data for new user","description":"ROOT CAUSE: Race condition in logout flow - async onAuthStateChange event fires AFTER redirect, causing stale filters to persist when new user logs in quickly.\n\nIMPACT:\n- Admin Daerah logs out with filter 'Desa Baleendah' active\n- Admin Desa Soreang logs in quickly (within race window)\n- Stale filter persists ‚Üí No data shown for Admin Desa Soreang\n- Affects ALL logout scenarios (button, session expired, revoked access)\n\nEVIDENCE:\n1. signOut() server action redirects immediately without clearing cache\n2. clearUserCache() only called in async onAuthStateChange handler (line 154)\n3. Race condition window: redirect happens ‚Üí new login ‚Üí THEN cache clears (too late!)\n4. Multiple logout scenarios NOT handled: session expired, admin revoke, force-stop PWA\n\nSOLUTION: Multi-Layer Defense Strategy\n\nLAYER 1 - Button Logout (Synchronous Clear):\n- Call clearUserCache(false) BEFORE signOut() in UserDropdown\n- Guarantees cache clear before redirect for intentional logouts\n\nLAYER 2 - Auto-Logout Handler (Logout Detection):\n- Set 'logout-pending' flag in sessionStorage when SIGNED_OUT event fires\n- Persists across page reloads but clears on browser close\n- Handles session expired, admin revoke, auto-logout scenarios\n\nLAYER 3 - Login Pre-Check (Race Condition Prevention):\n- Check 'logout-pending' flag on SIGNED_IN event\n- Force clearUserCache(false) BEFORE fetching new user data\n- Prevents stale filters even if login happens during race window\n\nFILES AFFECTED:\n- src/lib/userUtils.ts - Add optional shouldReload parameter to clearUserCache()\n- src/components/layouts/header/UserDropdown.tsx - Layer 1 implementation\n- src/components/layouts/AdminLayoutProvider.tsx - Layer 2 \u0026 3 implementation\n- src/lib/__tests__/userUtils.test.ts - Add tests for clearUserCache(shouldReload)\n\nTESTING SCENARIOS:\n1. Button logout ‚Üí quick re-login (Layer 1)\n2. Session expired ‚Üí auto-logout ‚Üí quick re-login (Layer 2 \u0026 3)\n3. Multiple tabs ‚Üí logout in tab A ‚Üí login in tab B (Layer 2 \u0026 3)\n4. PWA force-stop ‚Üí session persist ‚Üí account switch (Layer 3)\n5. Admin revoke access ‚Üí auto-logout ‚Üí re-login (Layer 2 \u0026 3)","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-28T14:14:03.026977+07:00","created_by":"abuabdirohman","updated_at":"2026-02-28T15:22:55.836318+07:00","closed_at":"2026-02-28T15:22:55.836318+07:00","close_reason":"Implementation complete and tested. Multi-layer defense successfully prevents stale filters on logout. Manual refresh still needed after login (acceptable improvement vs double logout-login). Follow-up issue sm-4u1 created for eliminating manual refresh."}
{"id":"sm-5nw","title":"Audit and centralize all type/interface definitions","description":"**IMPORTANT**: This task should be executed AFTER the god file decomposition refactoring (sm-vpo, sm-dsw, sm-9o0, sm-uk4) is complete. Types extracted during refactoring (sm-s3y) will inform this comprehensive audit. Follow type extraction pattern from docs/plan/refactoring-god-file-decomposition.md.\n\n---\n\n## Context\nStudent type fragmentation was discovered during sm-8yf implementation. Multiple conflicting Student interfaces existed across the codebase:\n- src/lib/studentPermissions.ts (with full_name)\n- src/app/(admin)/users/siswa/actions.ts (with name)\n- src/app/(admin)/users/siswa/types.ts (StudentBiodata)\n\nThis caused runtime errors and type mismatches.\n\n## Solution Implemented\nCreated centralized types at src/types/student.ts with hierarchy:\n- StudentBase ‚Üí StudentWithOrg ‚Üí StudentWithClasses ‚Üí StudentBiodata\n- All modules now import from central location\n\n## Task: Comprehensive Type Audit\n\n**Scope**: Search entire codebase for similar type fragmentation patterns\n\n**Areas to Audit**:\n1. **User/Profile types** - Check for duplicate UserProfile definitions\n2. **Class/ClassMaster types** - Verify single source of truth\n3. **Meeting types** - Check for meeting type duplicates (sm-s3y will extract these)\n4. **Organization types** (Daerah, Desa, Kelompok) - Verify consistency\n5. **Attendance types** - Check AttendanceLog definitions (sm-s3y will extract these)\n6. **Report/Rapot types** - Verify single source\n7. **Material types** - Check for duplicates\n\n**Checklist**:\n- [ ] Review types extracted by sm-s3y during refactoring\n- [ ] Grep for \"interface Student\" and \"type Student\" across src/\n- [ ] Grep for \"interface User\" and \"interface Profile\"\n- [ ] Grep for \"interface Class\" (exclude CSS classes)\n- [ ] Grep for \"interface Meeting\" and \"type Meeting\"\n- [ ] Grep for duplicate org types (Daerah, Desa, Kelompok)\n- [ ] Grep for \"interface Attendance\"\n- [ ] Check if types should live in src/types/ or stay local\n- [ ] Create centralized types where needed\n- [ ] Update CLAUDE.md with type centralization rules\n- [ ] Document type guidelines in src/types/README.md\n\n## CLAUDE.md Update Required\n\nAdd section: **Type/Interface Guidelines**\n\n**Rules**:\n1. ‚úÖ **Centralize shared types** in src/types/ directory\n2. ‚ùå **Never duplicate type definitions** across files\n3. ‚úÖ **Use type hierarchy** (Base ‚Üí Extended ‚Üí Full) for complex entities\n4. ‚úÖ **Re-export for backward compatibility** when moving types\n5. ‚úÖ **Name consistently**: UserBase, UserWithRole, UserProfile (not User1, User2)\n6. ‚ö†Ô∏è **Local types OK** for: Component-specific props, form data, internal state\n7. ‚ö†Ô∏è **Centralize types for**: Database entities, API responses, shared business logic\n\n**Example Hierarchy**:\n```typescript\n// src/types/student.ts - Central location\nexport interface StudentBase { id, name, gender, status }\nexport interface StudentWithOrg extends StudentBase { org fields }\nexport interface StudentFull extends StudentWithOrg { all fields }\n\n// Other files import, don't redeclare\nimport type { StudentWithOrg } from '@/types/student'\n```\n\n**Check Before Creating Types**:\n- Search codebase: \"interface MyType\" OR \"type MyType\"\n- If exists ‚Üí import it, don't recreate\n- If needs extension ‚Üí use extends, don't copy-paste\n\n**Migration Strategy**:\n1. Create src/types/[entity].ts with centralized definitions\n2. Update imports in all files\n3. Keep old file with re-exports for backward compatibility\n4. Add deprecation comment pointing to new location\n\n## Success Criteria\n- [ ] All duplicate types identified and documented\n- [ ] Centralized types created where appropriate\n- [ ] All imports updated to use central types\n- [ ] TypeScript compilation passes with no errors\n- [ ] CLAUDE.md updated with type centralization rules\n- [ ] src/types/README.md created with examples\n- [ ] Tests pass after refactor\n\n---\n\n**GitHub Issue**: https://github.com/abuabdirohman4/generus-mandiri/issues/11","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-11T11:27:26.794727+07:00","created_by":"abuabdirohman","updated_at":"2026-03-01T12:39:29.111381+07:00","dependencies":[{"issue_id":"sm-5nw","depends_on_id":"sm-s3y","type":"blocks","created_at":"2026-03-01T12:39:42.02344+07:00","created_by":"abuabdirohman"}]}
{"id":"sm-5pe","title":"Student management - Hard Delete and Transfer History","description":"Implement remaining student management features from sm-8yf scope.\n\nFeatures to Implement:\n\n1. Hard Delete with Confirmation\n   - Permanent removal of student record (GDPR compliance)\n   - Superadmin only permission\n   - Confirmation dialog with student name verification\n   - Warning: This action cannot be undone\n   - Cascade delete: Remove from student_classes, attendance_logs, rapot_data\n   - Database: DELETE FROM students WHERE id = ?\n\n2. Transfer History View\n   - Show transfer request history for a student\n   - Display: Date, From Org, To Org, Status, Requester, Reviewer\n   - Filter: All / Approved / Rejected / Cancelled\n   - Accessible from student detail page\n   - Query transfer_requests table WHERE student_ids contains student.id\n\n3. Soft Delete UI Enhancement\n   - Add restore button in archived/deleted students view\n   - Show deleted_at timestamp\n   - Auto-cleanup after retention period (optional, needs migration)\n\nTechnical Implementation:\n\nHard Delete Action:\n- Permission check: canHardDeleteStudent(user, student)\n- Confirmation modal with text input (type student name)\n- Server action: hardDeleteStudent(studentId)\n- Use admin client to bypass RLS\n- Transaction: Delete from all related tables\n\nTransfer History:\n- New component: TransferHistoryModal\n- Query: SELECT * FROM transfer_requests WHERE student.id = ANY(student_ids)\n- Show timeline with status badges\n- Link to requester and reviewer profiles\n\nDatabase Considerations:\n- Ensure foreign key constraints handle cascades\n- Audit trail for hard deletes (optional log table)\n- Retention policy for soft-deleted records\n\nDependencies: sm-8yf (completed)\nPriority: Medium\nType: Feature\n\n---\n\n**GitHub Issue**: https://github.com/abuabdirohman4/generus-mandiri/issues/7","status":"open","priority":2,"issue_type":"feature","created_at":"2026-02-11T15:21:02.180304+07:00","created_by":"abuabdirohman","updated_at":"2026-02-15T05:11:27.316775+07:00"}
{"id":"sm-6gn","title":"Write tests for utility functions (Priority 1)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-10T08:32:12.306887+07:00","created_by":"abuabdirohman","updated_at":"2026-02-26T10:01:39.652457+07:00","closed_at":"2026-02-26T10:01:40.652457+07:00","close_reason":"‚úÖ Phase 2 Complete! All Priority 1 utilities tested with 60/60 tests passing.\n\nCoverage achieved:\n- accessControlServer.ts: 69% statements, 100% branches, 80% functions\n- attendanceCalculation.ts: 68% statements, 100% branches, 83% functions  \n- userUtils.ts: 100% statements, 87.5% branches, 100% functions\n- utils.ts: 91% statements, 64% branches, 87.5% functions\n- classHelpers.ts: 100% coverage (Phase 1)\n- batchFetching.ts: 100% coverage (Phase 1)\n\nTest files created:\n- src/lib/__tests__/accessControlServer.test.ts (14 tests)\n- src/lib/utils/__tests__/attendanceCalculation.test.ts (12 tests)\n- src/lib/__tests__/userUtils.test.ts (5 tests)\n- src/lib/__tests__/utils.test.ts (8 tests)\n\nAverage coverage: ~88% across all Priority 1 utilities. Exceeded target of 70-80%!","dependencies":[{"issue_id":"sm-6gn","depends_on_id":"sm-qrt","type":"blocks","created_at":"2026-02-10T08:32:58.235922+07:00","created_by":"abuabdirohman"}],"deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"sm-8yf","title":"Feature: Student management actions (Archive, Transfer, Soft Delete, Hard Delete) with teacher permissions","description":"## Overview\nImplement student lifecycle management with approval-based transfer workflow. Students can be archived (graduated/inactive), transferred with approval system, and deleted (soft/hard) with role-based permissions.\n\n## üéØ Key Features\n\n### 1. Archive Student (with Status)\n**No approval needed** - Immediate action\n\n### 2. **Transfer Student (Approval-Based Workflow)** ‚≠ê NEW APPROACH\n**Cross-boundary transfers allowed with approval system**\n\n### 3. Soft Delete (Restorable)\n**No approval needed** - Immediate action\n\n### 4. Hard Delete (Permanent)\n**Superadmin only** - No approval needed\n\n---\n\n## üîÑ Transfer Workflow (Approval-Based System)\n\n### Core Principles:\n1. ‚úÖ **Can request transfer anywhere** (no hard boundaries)\n2. ‚úÖ **Auto-approved if within same organization scope**\n3. ‚úÖ **Needs approval if crossing organizational boundaries**\n4. ‚úÖ **Reviewer must have authority over destination organization**\n5. ‚úÖ **Support bulk transfers** (multiple students in one request)\n\n### Transfer Rules:\n\n| Scenario | Auto-Approved? | Reviewer Needed? |\n|----------|---------------|------------------|\n| Same Kelompok (class change only) | ‚úÖ Yes | ‚ùå No |\n| Different Kelompok, Same Desa | ‚úÖ Yes | ‚ùå No |\n| Different Desa, Same Daerah | ‚ùå No | ‚úÖ Admin Desa (target) |\n| Different Daerah | ‚ùå No | ‚úÖ Admin Daerah (target) |\n| Superadmin transfer | ‚úÖ Yes (bypass) | ‚ùå No |\n\n### Request Status Flow:\n```\n[Created] ‚Üí pending\n    ‚Üì\n    ‚îú‚îÄ‚Üí Auto-approved (same org) ‚Üí approved ‚Üí executed\n    ‚îÇ\n    ‚îî‚îÄ‚Üí Needs approval (cross-boundary) ‚Üí pending\n            ‚Üì\n            ‚îú‚îÄ‚Üí [Reviewer: Approve] ‚Üí approved ‚Üí executed\n            ‚îÇ\n            ‚îú‚îÄ‚Üí [Reviewer: Reject] ‚Üí rejected (can re-submit)\n            ‚îÇ\n            ‚îî‚îÄ‚Üí [Requester: Cancel] ‚Üí cancelled\n```\n\n---\n\n## üóÑÔ∏è Database Schema\n\n### New Table: transfer_requests\n```sql\nCREATE TABLE transfer_requests (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  \n  -- Students being transferred (supports bulk)\n  student_ids UUID[] NOT NULL, -- Array of student IDs\n  \n  -- Source organization (current)\n  from_daerah_id UUID REFERENCES daerah(id),\n  from_desa_id UUID REFERENCES desa(id),\n  from_kelompok_id UUID REFERENCES kelompok(id),\n  \n  -- Destination organization (target)\n  to_daerah_id UUID REFERENCES daerah(id),\n  to_desa_id UUID REFERENCES desa(id),\n  to_kelompok_id UUID REFERENCES kelompok(id),\n  to_class_ids UUID[], -- Optional: specific classes to assign\n  \n  -- Request metadata\n  requested_by UUID REFERENCES profiles(id) NOT NULL,\n  requested_at TIMESTAMPTZ DEFAULT NOW(),\n  reason TEXT, -- Required for cross-boundary transfers\n  notes TEXT,\n  \n  -- Approval workflow\n  status VARCHAR(20) DEFAULT 'pending' \n    CHECK (status IN ('pending', 'approved', 'rejected', 'cancelled')),\n  \n  reviewed_by UUID REFERENCES profiles(id),\n  reviewed_at TIMESTAMPTZ,\n  review_notes TEXT,\n  \n  -- Execution\n  executed_at TIMESTAMPTZ,\n  executed_by UUID REFERENCES profiles(id),\n  \n  -- Audit\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\nCREATE INDEX idx_transfer_requests_status ON transfer_requests(status);\nCREATE INDEX idx_transfer_requests_students ON transfer_requests USING GIN(student_ids);\nCREATE INDEX idx_transfer_pending_target ON transfer_requests(to_daerah_id, to_desa_id, to_kelompok_id) \n  WHERE status = 'pending';\nCREATE INDEX idx_transfer_requester ON transfer_requests(requested_by);\n```\n\n### Update: students table\n```sql\nALTER TABLE students\n  ADD COLUMN status VARCHAR(20) DEFAULT 'active'\n    CHECK (status IN ('active', 'graduated', 'inactive')),\n  ADD COLUMN archived_at TIMESTAMPTZ,\n  ADD COLUMN archived_by UUID REFERENCES profiles(id),\n  ADD COLUMN archive_notes TEXT,\n  ADD COLUMN transfer_history JSONB DEFAULT '[]'::jsonb;\n  -- deleted_at already exists\n\nCREATE INDEX idx_students_status ON students(status);\nCREATE INDEX idx_students_archived ON students(archived_at) WHERE archived_at IS NOT NULL;\n```\n\n### Update: profiles table\n```sql\nALTER TABLE profiles\n  ADD COLUMN permissions JSONB DEFAULT '{\n    \"can_archive_students\": false,\n    \"can_transfer_students\": false,\n    \"can_soft_delete_students\": false\n  }'::jsonb,\n  ADD COLUMN notification_badge JSONB DEFAULT '{\n    \"pending_transfer_requests\": 0\n  }'::jsonb;\n\nCREATE INDEX idx_profiles_permissions ON profiles USING GIN(permissions);\n```\n\n---\n\n## üìã Implementation Tasks\n\n### Phase 1: Database \u0026 Permissions (Priority: High)\n- [ ] Migration: `transfer_requests` table\n- [ ] Migration: `students` status fields\n- [ ] Migration: `profiles.permissions` JSONB\n- [ ] RLS policies for `transfer_requests`\n- [ ] **TDD**: Write tests for permission utilities ‚úÖ DONE\n  - `canRequestTransfer()` ‚úÖ\n  - `canReviewTransferRequest()` \n  - `needsApproval()`\n  - `isOrganizationInUserHierarchy()`\n\n### Phase 2: Transfer Request Server Actions (Priority: High)\n- [ ] `createTransferRequest(studentIds, targetOrg, reason)`\n  - Auto-approve if `needsApproval() === false`\n  - Create pending request if needs approval\n  - Update notification badge for target admin\n- [ ] `approveTransferRequest(requestId, notes)`\n  - Validate reviewer has authority\n  - Execute transfer (update `student.daerah_id`, etc.)\n  - Update `student.transfer_history`\n  - Clear notification badge\n- [ ] `rejectTransferRequest(requestId, notes)`\n  - Mark as rejected\n  - Clear notification badge\n  - Allow re-submission\n- [ ] `cancelTransferRequest(requestId)`\n  - Requester can cancel pending requests\n- [ ] `getPendingTransferRequests(userId)`\n  - Get requests awaiting user's review\n- [ ] `getMyTransferRequests(userId)`\n  - Get requests created by user\n\n### Phase 3: Archive \u0026 Delete Actions (Priority: High)\n- [ ] `archiveStudent(studentId, status: 'graduated'|'inactive', notes)`\n- [ ] `unarchiveStudent(studentId)`\n- [ ] `softDeleteStudent(studentId)` (update existing)\n- [ ] `restoreStudent(studentId)`\n- [ ] `hardDeleteStudent(studentId, confirmToken)` (superadmin only)\n\n### Phase 4: UI Components (Priority: Medium)\n- [ ] `TransferRequestModal` (NEW)\n  - Select destination (no restrictions on dropdown)\n  - Bulk student selection\n  - Reason field (required if cross-boundary)\n  - Preview: \"Auto-approved\" vs \"Needs approval from X\"\n- [ ] `PendingTransferRequestsSection` (NEW)\n  - List requests awaiting review\n  - Approve/Reject buttons\n  - Show student details, reason, requester\n- [ ] `TransferRequestHistoryModal` (NEW)\n  - Show request status (pending/approved/rejected)\n  - Timeline view\n- [ ] `NotificationBadge` (NEW)\n  - Show count of pending requests\n  - Click ‚Üí navigate to requests section\n- [ ] `ArchiveStudentModal`\n  - Status selector (graduated/inactive)\n  - Notes field\n- [ ] Update `DeleteStudentModal`\n  - Soft delete confirmation\n- [ ] `HardDeleteConfirmDialog`\n  - Superadmin only\n  - Type DELETE confirmation\n\n### Phase 5: Notification System (Priority: Medium)\n- [ ] In-app notification badge (no email)\n- [ ] Update `profiles.notification_badge` on request creation\n- [ ] Clear badge on request review\n- [ ] Real-time updates with Supabase Realtime (optional)\n\n### Phase 6: Testing (Priority: High)\n- [ ] Unit tests for permission utilities ‚úÖ DONE (38 tests)\n  - `canArchiveStudent()` ‚úÖ\n  - `canTransferStudent()` ‚úÖ (need to update for new workflow)\n  - `canSoftDeleteStudent()` ‚úÖ\n  - `canHardDeleteStudent()` ‚úÖ\n- [ ] Unit tests for new approval functions\n  - `canRequestTransfer()`\n  - `canReviewTransferRequest()`\n  - `needsApproval()`\n- [ ] Integration tests\n  - Auto-approved transfer flow\n  - Approval-required transfer flow\n  - Bulk transfer (5 students at once)\n  - Rejection and re-submission\n  - Archive/unarchive\n  - Soft delete/restore\n  - Hard delete cascade\n\n---\n\n## üéØ Success Criteria\n\n‚úÖ Admin can request transfer to ANY organization (no dropdown restrictions)\n‚úÖ Transfers within same org are auto-approved (immediate)\n‚úÖ Cross-boundary transfers create pending request\n‚úÖ Target admin receives in-app notification badge\n‚úÖ Target admin can approve/reject with notes\n‚úÖ Rejected requests can be re-submitted\n‚úÖ Bulk transfer (multiple students) in single request\n‚úÖ No expiration on pending requests\n‚úÖ Archived students hidden from active lists\n‚úÖ Soft deleted students can be restored\n‚úÖ Hard delete requires superadmin + double confirmation\n‚úÖ Full audit trail in `transfer_requests` and `transfer_history`\n\n---\n\n## üö® Edge Cases\n\n1. **Student already has pending transfer** ‚Üí Show warning, allow cancel old request\n2. **Request for deleted student** ‚Üí Not allowed, must restore first\n3. **Reviewer deletes their account** ‚Üí Request stays pending, other admins at same level can review\n4. **Student enrolled in multiple classes** ‚Üí Transfer updates org but keeps class enrollments (admin must manually update)\n5. **Bulk transfer with mix of statuses** ‚Üí Show which will auto-approve vs need approval\n6. **Requester cancels after reviewer approves** ‚Üí Cannot cancel approved requests\n7. **Destination org gets deleted** ‚Üí Request auto-cancelled with notification\n\n---\n\n## üìä Database Queries Examples\n\n### Get pending requests for reviewer\n```sql\n-- Admin Desa viewing requests targeting their desa\nSELECT tr.*, \n       array_agg(s.full_name) as student_names,\n       p.full_name as requester_name\nFROM transfer_requests tr\nJOIN profiles p ON tr.requested_by = p.id\nJOIN students s ON s.id = ANY(tr.student_ids)\nWHERE tr.status = 'pending'\n  AND tr.to_desa_id = :user_desa_id\n  AND (:user_role = 'superadmin' OR tr.to_daerah_id = :user_daerah_id)\nGROUP BY tr.id, p.full_name\nORDER BY tr.requested_at DESC;\n```\n\n### Update notification badge\n```sql\n-- Count pending requests for user's org\nUPDATE profiles\nSET notification_badge = jsonb_set(\n  notification_badge,\n  '{pending_transfer_requests}',\n  to_jsonb((\n    SELECT COUNT(*)\n    FROM transfer_requests\n    WHERE status = 'pending'\n      AND to_desa_id = :user_desa_id\n  ))\n)\nWHERE id = :user_id;\n```\n\n---\n\n## üîó Related Beads\n\n- Depends on: Database schema design\n- Blocks: UI implementation\n- Related: User permissions management\n\n---\n\n## üìù Notes\n\n- **Breaking change** from original plan: Transfer boundaries are now request-based, not hard restrictions\n- Existing `canTransferStudent()` tests need update to new `canRequestTransfer()` logic\n- Consider adding `transfer_requests_history` table for long-term audit (archive old completed/rejected requests)\n- Future: Add batch approval (approve 10 requests at once)\n- Future: Add delegation (admin can delegate approval authority to another admin)","notes":"## Phase 3 Progress Update (2026-02-11)\n\n### ‚úÖ Completed UI Components:\n- ArchiveStudentModal\n- TransferRequestModal  \n- PendingTransferRequestsSection\n- NotificationBadge\n- Unarchive feature (bonus)\n\n### ‚ùå Remaining Tasks:\n1. TransferRequestHistoryModal (audit trail)\n2. HardDeleteConfirmDialog (safety measure)\n3. Integration tests for transfer workflow\n\n---\n\n## üêõ Bugs \u0026 Issues Found (User Feedback):\n\n### Bug 1: Transfer Modal - Incorrect Org Filtering\n**Reported by**: Admin Kelompok Brangsong\n**Issue**: \n- Daerah dropdown only shows user's daerah (Kendal)\n- ‚ùå EXPECTED: Show ALL daerah in system\n- Desa dropdown ‚úÖ correct (shows all desa in selected daerah)\n- Kelompok dropdown only shows user's kelompok\n- ‚ùå EXPECTED: Show all kelompok in selected desa\n\n**Root Cause**: TransferRequestModal filtering org lists by user's hierarchy instead of showing all orgs\n**Fix Required**: Remove user hierarchy filter from daerah/kelompok lists in TransferRequestModal\n\n### Bug 2: Laporan Page - Multi-Kelompok Filter Issue\n**Issue**: When user selects multiple kelompok then selects class, kelompok filter gets cleared\n**Impact**: Cannot generate reports for multiple kelompok at once\n**Related File**: src/app/(admin)/laporan/page.tsx or components\n**See**: New issue sm-XXX (Laporan multi-kelompok filter bug)\n\n---\n\n## üéØ Feature Requests (User Feedback):\n\n### FR1: Teacher Transfer Permission\n**Request**: Role \"teacher\" should also have access to Transfer feature (like admin)\n**Current**: Only admin/superadmin can transfer\n**Desired**: Teacher with `permissions.can_transfer_students = true` can use Transfer feature\n**Implementation**:\n- Update TransferRequestModal to show for teachers with permission\n- Update page.tsx to pass onTransfer to table for teachers\n- Permission check already exists in `canRequestTransfer()`\n\n### FR2: Hide \"Permintaan Transfer\" Tab When Empty\n**Request**: Tab should only appear when there are pending requests\n**Current**: Tab always visible for admin (even when 0 requests)\n**Desired**: `{pendingRequests.length \u003e 0 \u0026\u0026 \u003cTab\u003e...}`\n**Impact**: Cleaner UI, less clutter\n\n### FR3: Move Status Filter to DataFilter Component\n**Request**: Centralize status filter in DataFilter.tsx for reuse\n**Current**: Status filter is inline in siswa/page.tsx\n**Desired**: \n- Add `showStatus?: boolean` prop to DataFilter\n- Move dropdown to DataFilter.tsx\n- Update CLAUDE.md with guideline: \"If filter will be reused, add to DataFilter.tsx\"\n**Benefits**: Consistency, reusability (can use in Guru, Laporan, etc.)\n\n### FR4: Teacher Permission Management UI\n**Request**: Add permission toggles in /users/guru page\n**Current**: No UI to grant permissions to teachers\n**Desired**: Checkboxes for:\n- ‚òê Can Archive Students\n- ‚òê Can Transfer Students  \n- ‚òê Can Soft Delete Students\n- ‚òê Can Hard Delete Students (superadmin only)\n**Implementation**: Update GuruModal or add PermissionsModal\n\n---\n\n## üìù Related New Issues:\n\n1. **sm-XXX**: Teacher roles for Desa and Daerah levels (like Kelompok)\n   - Allow creating teachers at desa/daerah level\n   - Configurable permissions per teacher level\n   - Access scoping based on hierarchy\n\n2. **sm-XXX**: Laporan page multi-kelompok filter bug\n   - Kelompok filter clears when class is selected\n   - Prevents multi-kelompok reports\n\n---\n\n## Next Steps:\n1. Fix Bug 1 (transfer modal org filtering) - HIGH PRIORITY\n2. Implement FR1 (teacher transfer permission) - HIGH PRIORITY  \n3. Implement FR2 (hide empty tab) - QUICK WIN\n4. Fix Bug 2 (laporan filter) or create separate issue\n5. Implement FR3 (centralize status filter) - MEDIUM\n6. Implement FR4 (teacher permissions UI) - MEDIUM\n7. Complete remaining Phase 3 tasks (history modal, hard delete confirm)\n8. Integration tests","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-02-04T21:17:45.025032+07:00","created_by":"abuabdirohman","updated_at":"2026-02-26T10:01:39.652457+07:00","closed_at":"2026-02-26T10:01:40.652457+07:00","close_reason":"Core features complete: ‚úÖ Archive (graduated/inactive status), ‚úÖ Transfer with approval-based workflow (auto-approve same org, pending for cross-boundary), ‚úÖ Unarchive. Permission logic tested (66 tests, 100% coverage). Server actions implemented. UI components added (Archive/Transfer/Unarchive modals). Remaining enhancements moved to new issues (cancel request, mass transfer, hard delete, history).","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"sm-8yt","title":"Bug: DataFilter layout for 3 filters not aligned properly for admin desa","description":"\n## Problem\nWhen admin_desa users view pages with DataFilter showing 3 filters (e.g., Kelompok, Kelas, Jenis Kelamin), the layout is not properly aligned. The filters appear in different rows with inconsistent widths.\n\n## Current Behavior\n- All 3 filters appear on separate rows\n- Filter widths are not equal\n- Layout looks messy and unprofessional\n\n## Expected Behavior\n- 2 filters on top row (equal width)\n- 1 filter on bottom row (full width on mobile, equal width on desktop)\n- All filters should be aligned and have consistent spacing\n\n## Location\nFile: src/components/shared/DataFilter.tsx\nLines: 570-598\n\n## Current Code Issue\nLine 576 uses `grid-cols-2 md:grid-cols-4` for filterCount 2-4, which doesn't handle 3 filters properly.\nThe `getFilterClass` function attempts to fix this with col-span, but the base grid is incorrect.\n\n## Attempted Fix (Reverted)\nChanged line 576 to separate cases:\n- filterCount === 2: grid-cols-2 md:grid-cols-4\n- filterCount === 3: grid-cols-2 md:grid-cols-3\n- filterCount === 4: grid-cols-2 md:grid-cols-4\n\nBut this was reverted by linter/prettier.\n\n## Solution Needed\nNeed to implement proper grid layout for 3 filters that:\n1. Works on mobile (2 cols, last spans 2)\n2. Works on desktop (3 equal cols)\n3. Survives linter/prettier formatting\n\n---\n\n**GitHub Issue**: https://github.com/abuabdirohman4/generus-mandiri/issues/12","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-02-04T21:16:35.534343+07:00","created_by":"abuabdirohman","updated_at":"2026-02-26T11:19:31.431234+07:00","closed_at":"2026-02-26T11:19:31.431234+07:00","close_reason":"Closed"}
{"id":"sm-9fj","title":"Eliminate manual refresh after login when filters are cleared","description":"CURRENT STATE: After sm-4u0 fix, stale filters are cleared on logout but user still needs to manually refresh page after login to see data.\n\nOBSERVED BEHAVIOR:\n1. Admin Daerah logs out with filter 'Desa Baleendah' ‚úÖ\n2. Filters cleared from localStorage ‚úÖ\n3. Admin Desa Soreang logs in ‚úÖ\n4. Page shows but data is empty ‚ö†Ô∏è\n5. User manually refreshes ‚Üí Data appears ‚úÖ\n\nROOT CAUSE (SUSPECTED):\n- Zustand stores still have old filter values in memory\n- Data fetch happens BEFORE Zustand rehydrates from cleared localStorage\n- Components read from in-memory state instead of cleared localStorage\n\nEXPECTED BEHAVIOR:\n- Login ‚Üí Data loads immediately without manual refresh\n- No user intervention needed\n\nINVESTIGATION NEEDED:\n1. Check Zustand rehydration timing vs data fetch\n2. Verify filter state in siswaStore, laporanStore, dashboardStore\n3. Check if stores need explicit reset on login\n4. Review AdminLayoutProvider fetchUserData() timing\n\nRELATED: sm-4u0 (parent fix for logout filter reset)\n\nPRIORITY: Medium (P2) - Nice to have, current workaround is acceptable","status":"in_progress","priority":2,"issue_type":"feature","created_at":"2026-02-28T15:23:17.974556+07:00","created_by":"abuabdirohman","updated_at":"2026-02-28T15:24:25.662236+07:00"}
{"id":"sm-9hh","title":"Unit tests for student management server actions","description":"Write unit tests for server actions in management.ts to ensure transfer workflow correctness.\n\nTest Coverage Needed:\n\n1. createTransferRequest()\n   - Test auto-approval for same organization transfers\n   - Test pending status for cross-boundary transfers\n   - Test duplicate request detection (same student, same target, pending)\n   - Test bulk transfer (multiple students)\n   - Test permission validation\n   - Test invalid target organization\n\n2. approveTransferRequest()\n   - Test actual student data update (org fields, class_id)\n   - Test status change to approved\n   - Test reviewer permission validation\n   - Test class assignment (with and without classes)\n   - Test student_classes junction table update\n   - Edge case: Request already processed\n\n3. rejectTransferRequest()\n   - Test status change to rejected\n   - Test reviewer permission validation\n   - Test student data unchanged\n   - Edge case: Request already processed\n\n4. cancelTransferRequest()\n   - Test status change to cancelled\n   - Test requester permission validation\n   - Test only pending requests can be cancelled\n   - Edge case: Non-requester tries to cancel\n\n5. archiveStudent() / unarchiveStudent()\n   - Test status updates (active \u003c-\u003e graduated/inactive)\n   - Test permission validation\n   - Test student visibility in queries\n\n6. restoreStudent()\n   - Test deleted_at cleared\n   - Test permission validation\n   - Test soft-deleted student restored\n\nTesting Strategy:\n- Use MSW (Mock Service Worker) to mock Supabase responses\n- Create mock data fixtures for students, requests, organizations\n- Test both happy path and error cases\n- Verify database mutation calls\n- Check permission logic integration\n\nSetup Required:\n- Install msw package\n- Create Supabase mock handlers in src/test/mocks/supabase.ts\n- Create test fixtures in src/test/fixtures/students.ts\n- Follow TDD approach from sm-8yf (66 tests, 100% coverage)\n\nExpected Outcome:\n- 30-40 tests covering all server actions\n- 80%+ coverage of management.ts\n- Catch edge cases and permission bugs\n- Ensure data integrity during transfers\n\nDependencies: sm-8yf (permission logic tested), sm-6gn (test infrastructure)\nPriority: Medium (high value, requires MSW setup)\nType: Task\n\n---\n\n**GitHub Issue**: https://github.com/abuabdirohman4/generus-mandiri/issues/6","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-11T15:21:27.85564+07:00","created_by":"abuabdirohman","updated_at":"2026-02-15T05:11:04.529498+07:00"}
{"id":"sm-9kn","title":"Transfer workflow enhancements - Cancel, mass transfer, auto-refresh","description":"Add enhancements to student transfer workflow:\n\n**Features to implement:**\n1. **Cancel Transfer Request** (Batalkan)\n   - Add 'Batalkan' button for pending requests created by user\n   - Only requester can cancel their own pending requests\n   - Update status to 'cancelled' in database\n   - Show in request history with cancelled badge\n\n2. **Mass Transfer** (Bulk Transfer)\n   - Select multiple students for bulk transfer operations\n   - Use checkboxes in student table\n   - Single modal to transfer multiple students at once\n   - Common use case: Grade promotions (promote entire class)\n   - Validation: All students must be eligible for target org/class\n\n3. **Auto-refresh After Transfer**\n   - Student appears/disappears immediately from list after transfer\n   - No manual refresh needed\n   - Use SWR mutate to invalidate cache\n   - Show success toast with student name\n\n**Technical Notes:**\n- Cancel button: Check requester_id === current_user_id\n- Mass transfer: Reuse createTransferRequest with student_ids array\n- Auto-refresh: mutate(studentKeys.all()) after successful transfer\n\n**Dependencies:** Requires sm-8yf (completed)\n**Priority:** Medium (UX improvements)\n**Type:** Feature\n\n---\n\n**GitHub Issue**: https://github.com/abuabdirohman4/generus-mandiri/issues/8","status":"open","priority":2,"issue_type":"feature","created_at":"2026-02-11T15:19:00.886237+07:00","created_by":"abuabdirohman","updated_at":"2026-02-15T05:11:29.080327+07:00"}
{"id":"sm-9o0","title":"Split laporan/actions.ts into actions/ folder","status":"open","priority":2,"issue_type":"task","created_at":"2026-03-01T12:06:28.934153+07:00","created_by":"abuabdirohman","updated_at":"2026-03-01T12:06:28.934153+07:00","dependencies":[{"issue_id":"sm-9o0","depends_on_id":"sm-vpo","type":"blocks","created_at":"2026-03-01T12:06:57.685267+07:00","created_by":"abuabdirohman"}]}
{"id":"sm-a0y","title":"Refactor: Optimize absensi/actions.ts (2215 ‚Üí ~900 lines)","description":"Mengurangi kompleksitas dan duplikasi kode di src/app/(admin)/absensi/actions.ts dengan memecah logika berulang menjadi utility functions yang reusable.\n\n## üéØ Objectives\n- Reduce from 2215 lines to ~900 lines (-59%)\n- Eliminate ~1300 lines of duplicated code (-96%)\n- Split getMeetingsWithStats (986 lines ‚Üí ~200 lines per function)\n- Improve testability and maintainability\n\n## üìä Problem Analysis\n\n### Duplicated Code Identified:\n1. **Data Transformation Logic** (~360 lines duplicate)\n   - Transform array to object (kelompok/desa/daerah): 12x repetitions\n   - Build class names array: 6x repetitions\n   - Build allClasses array: 4x repetitions\n\n2. **Filter Logic** (~200 lines duplicate)\n   - Teacher class filtering: 3x repetitions\n   - Admin hierarchy filtering: 3x repetitions\n   - Pengajar access logic: 4x repetitions\n\n3. **Stats Calculation** (~300 lines duplicate)\n   - Attendance percentage calculation: 3x repetitions\n   - Student filtering by role: 3x repetitions\n   - Stats enrichment: 3x repetitions\n\n4. **Query Patterns** (~150 lines duplicate)\n   - Fetch classes with hierarchy: 6x repetitions\n   - Build class maps: 5x repetitions\n   - Fetch student-class mappings: 3x repetitions\n\n5. **Auth \u0026 Validation** (~100 lines duplicate)\n   - User + profile fetch: 8x repetitions\n   - Teacher class validation: 2x repetitions\n   - Student validation: 3x repetitions\n\n## üîß Implementation Phases\n\n### Phase 1: Extract Data Transformation Utilities (Reduction: ~310 lines)\n**Create:** src/lib/utils/dataTransformers.ts\n**Functions:**\n- transformClassWithHierarchy(classData)\n- transformMeetingClasses(meeting)\n- buildAllClassesArray(meeting, allClassesMap)\n- buildClassNamesArray(meeting, classNameMap)\n\n### Phase 2: Extract Query Helpers (Reduction: ~140 lines)\n**Create:** src/lib/utils/queryHelpers.ts\n**Functions:**\n- fetchClassesWithHierarchy(supabase, classIds)\n- buildClassMaps(classesData)\n- fetchStudentClassMappings(supabase, studentIds)\n\n### Phase 3: Extract Meeting Filter Logic (Reduction: ~340 lines)\n**Create:** src/app/(admin)/absensi/utils/meetingFilters.ts\n**Functions:**\n- filterMeetingsByTeacherClasses(meetings, teacherClassIds, ...)\n- filterMeetingsByAdminLevel(meetings, profile, ...)\n- checkPengajarAccess(meeting, teacherKelompokIds, classDetailsMap)\n\n### Phase 4: Extract Stats Calculation (Reduction: ~400 lines)\n**Create:** src/app/(admin)/absensi/utils/statsCalculators.ts\n**Functions:**\n- calculateMeetingStats(meeting, attendanceByMeeting, relevantStudentIds)\n- processRoleBasedStudentFilter(meeting, profile, ...)\n- enrichMeetingsWithStats(meetings, attendanceByMeeting, ...)\n\n### Phase 5: Extract Auth \u0026 Validation (Reduction: ~140 lines)\n**Create:** src/app/(admin)/absensi/utils/authHelpers.ts\n**Functions:**\n- getCurrentUserWithProfile(supabase, fields?)\n- validateTeacherClasses(adminClient, teacherId, classIds)\n- validateStudentSelection(adminClient, classIds, studentIds)\n\n### Phase 6: Split getMeetingsWithStats (Reduction: ~200 lines)\n**Create:** src/app/(admin)/absensi/utils/meetingQueries.ts\n**Structure:**\n- getMeetingsWithStats() - Main orchestrator (~100 lines)\n- getTeacherMeetingsWithStats() - Teacher-specific (~200 lines)\n- getAdminMeetingsWithStats() - Admin-specific (~180 lines)\n- getFallbackMeetingsWithStats() - Fallback (~100 lines)\n\n### Phase 7: Refactor actions.ts\n**Update all functions to use new utilities:**\n- createMeeting - Use authHelpers \u0026 validation\n- getMeetingById - Use dataTransformers\n- updateMeeting - Use authHelpers \u0026 validation\n- getMeetingsWithStats - Import from meetingQueries\n- getStudentsFromSnapshot - Use dataTransformers\n\n## üìÇ New File Structure\nsrc/lib/utils/\n‚îú‚îÄ‚îÄ dataTransformers.ts [NEW - ~150 lines]\n‚îú‚îÄ‚îÄ queryHelpers.ts [NEW - ~120 lines]\n\nsrc/app/(admin)/absensi/utils/\n‚îú‚îÄ‚îÄ authHelpers.ts [NEW - ~100 lines]\n‚îú‚îÄ‚îÄ meetingFilters.ts [NEW - ~200 lines]\n‚îú‚îÄ‚îÄ statsCalculators.ts [NEW - ~180 lines]\n‚îú‚îÄ‚îÄ meetingQueries.ts [NEW - ~150 lines]\n\nsrc/app/(admin)/absensi/\n‚îî‚îÄ‚îÄ actions.ts [REFACTORED - ~900 lines]\n\n**Total New Files:** 6\n**Total New LOC:** ~900 lines (reusable utilities)\n**Total Removed LOC:** ~1300 lines (duplications)\n**Net Reduction:** -400 lines + better modularity\n\n## ‚úÖ Acceptance Criteria\n- [ ] No duplicated logic (\u003c 50 lines duplication)\n- [ ] All functions \u003c 200 lines\n- [ ] All utilities have TypeScript interfaces\n- [ ] All utilities have JSDoc comments\n- [ ] All existing tests pass\n- [ ] Unit tests for new utility functions\n- [ ] No performance regression\n- [ ] Type checking passes (npm run type-check)\n- [ ] No new ESLint warnings\n- [ ] All public API signatures unchanged\n- [ ] Existing SWR hooks still work\n\n## üìä Success Metrics\n| Metric | Before | After | Target |\n|--------|--------|-------|--------|\n| Total LOC (actions.ts) | 2215 | ~900 | -59% |\n| Duplicated code | ~1300 | ~50 | -96% |\n| Longest function | 986 lines | ~200 lines | -80% |\n| Cyclomatic complexity | High | Low | ‚úÖ |\n| Utility files | 3 | 9 | Modular |\n\n## üîÑ Migration Strategy\n**Approach:** Incremental refactoring (backward compatible at each step)\n1. Phases 1-5: Create utilities without using them ‚Üí 0 risk\n2. Phase 6-7: Refactor one function at a time ‚Üí Test each change\n3. Each phase can be committed separately\n4. Rollback plan: Revert specific commit if issues arise\n\n## üß™ Testing Strategy\n**Unit Tests:** Test each utility function independently\n**Integration Tests:** All existing API tests must pass\n**Manual Testing:** Test with different user roles (teacher, admin, superadmin)\n\n## üêõ Known Risks \u0026 Mitigation\n**Risk 1:** Breaking existing functionality\n**Mitigation:** Keep all public APIs unchanged, test each phase\n\n**Risk 2:** Performance regression\n**Mitigation:** Measure query counts before/after, use same Supabase clients\n\n**Risk 3:** Type errors in complex transformations\n**Mitigation:** Strong typing for all utilities, unit tests for edge cases\n\n## üìÖ Timeline Estimate\n| Phase | Estimated Time | Risk Level |\n|-------|----------------|------------|\n| Phase 1 | 2 hours | Low |\n| Phase 2 | 1.5 hours | Low |\n| Phase 3 | 3 hours | Medium |\n| Phase 4 | 2.5 hours | Medium |\n| Phase 5 | 2 hours | Low |\n| Phase 6 | 3 hours | Medium |\n| Phase 7 | 4 hours | High |\n| Testing | 3 hours | - |\n| **Total** | **~21 hours** | **Medium** |\n\n## üìù Notes\n- This refactoring does NOT change any business logic\n- All RLS policies remain the same\n- Database queries are unchanged (only reorganized)\n- Existing SWR cache keys remain compatible\n- No changes to UI components needed\n\n## üîó Related Files\n**Files to Modify:**\n- src/app/(admin)/absensi/actions.ts\n\n**Files to Create:**\n- src/lib/utils/dataTransformers.ts\n- src/lib/utils/queryHelpers.ts\n- src/app/(admin)/absensi/utils/authHelpers.ts\n- src/app/(admin)/absensi/utils/meetingFilters.ts\n- src/app/(admin)/absensi/utils/statsCalculators.ts\n- src/app/(admin)/absensi/utils/meetingQueries.ts\n\n**Files to Reference:**\n- src/lib/utils/classHelpers.ts (existing patterns)\n- src/lib/utils/batchFetching.ts (existing patterns)\n- src/app/(admin)/laporan/actions.ts (similar complexity)\n\n## ‚ú® Future Improvements\nAfter this refactoring:\n1. Apply same patterns to laporan/actions.ts (~900 lines)\n2. Extract common attendance filtering to shared utilities\n3. Add performance monitoring/telemetry\n4. Implement request caching at server action level\n\nLabels: [absensi code-quality refactoring technical-debt]\n\n---\n\n**GitHub Issue**: https://github.com/abuabdirohman4/generus-mandiri/issues/13","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T07:42:57.808618+07:00","created_by":"abuabdirohman","updated_at":"2026-03-01T12:35:40.861186+07:00","closed_at":"2026-03-01T12:35:40.861186+07:00","close_reason":"Superseded by sm-vpo with unified 3-layer functional architecture. Old approach scattered utilities across multiple folders. New approach uses domain-based actions/ folder with 3 internal layers (queries, business logic, server actions). See docs/plan/refactoring-god-file-decomposition.md for unified pattern that will be applied consistently across ALL features.","labels":["absensi","code-quality","refactoring","technical-debt"]}
{"id":"sm-de3","title":"Bug: Laporan page multi-kelompok filter gets cleared when selecting class","description":"\n\n---\n\n**GitHub Issue**: https://github.com/abuabdirohman4/generus-mandiri/issues/9","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-02-11T12:25:21.109666+07:00","created_by":"abuabdirohman","updated_at":"2026-02-26T10:01:39.652457+07:00","closed_at":"2026-02-26T10:01:40.652457+07:00","close_reason":"Fixed auto-clear bug in Laporan filter + unified class format across all pages to show '(X kelompok)' suffix when 2+ kelompok selected. User confirmed working: 'sekarang sudah oke'","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"bug"}
{"id":"sm-dsw","title":"Split siswa/actions.ts into actions/ folder","status":"open","priority":2,"issue_type":"task","created_at":"2026-03-01T12:06:25.781305+07:00","created_by":"abuabdirohman","updated_at":"2026-03-01T12:06:25.781305+07:00","dependencies":[{"issue_id":"sm-dsw","depends_on_id":"sm-vpo","type":"blocks","created_at":"2026-03-01T12:06:53.260392+07:00","created_by":"abuabdirohman"}]}
{"id":"sm-eat","title":"Bug: Transfer without class selection keeps old org's classes","description":"Issue: When transferring a student to a different organization WITHOUT selecting new classes, the student retains classes from the old organization.\n\nExpected Behavior:\n- If no classes are selected during transfer, class_id should be null (empty)\n- Student should not be enrolled in any class after transfer\n- Admin can manually assign classes later\n\nCurrent Behavior:\n- Student keeps class_id from old organization\n- This is incorrect because classes belong to kelompok (organization)\n- Student shows in wrong class roster\n\nExample:\n1. Student in Kelompok A enrolled in Remaja A class\n2. Transfer to Kelompok B without selecting class\n3. Bug: Student still shows class_id from old org\n4. Expected: Student has class_id = null\n\nRoot Cause:\n- approveTransferRequest in management.ts does not update class_id when no class is selected\n- Only updates organizational fields (daerah_id, desa_id, kelompok_id)\n\nFix Required in approveTransferRequest:\nSet class_id to null if classIds array is empty\n\nTest Cases:\n1. Transfer with class selection\n2. Transfer without class selection (class_id = null)\n3. Verify student_classes junction table cleared\n\nPriority: High (data integrity issue)\n\n---\n\n**GitHub Issue**: https://github.com/abuabdirohman4/generus-mandiri/issues/4","status":"open","priority":1,"issue_type":"bug","created_at":"2026-02-11T15:20:29.109815+07:00","created_by":"abuabdirohman","updated_at":"2026-02-15T05:11:03.429518+07:00"}
{"id":"sm-ee7","title":"Add Teacher roles for Desa and Daerah levels with configurable permissions","description":"\n\n---\n\n**GitHub Issue**: https://github.com/abuabdirohman4/generus-mandiri/issues/10","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-11T12:22:47.026266+07:00","created_by":"abuabdirohman","updated_at":"2026-03-01T13:01:27.730006+07:00","closed_at":"2026-03-01T13:01:27.730083+07:00","close_reason":"Closed"}
{"id":"sm-eyo","title":"Add batch edit feature for students (gender \u0026 class)","description":"Implement batch/mass edit functionality in /users/siswa page to allow updating gender and class for multiple students at once.\n\n## Requirements\n- Add 'Batch Edit' button that toggles checkbox column\n- Checkboxes in leftmost column of each row\n- Click checkbox or row to select/unselect\n- Show selected count and mass update options above table\n- Support mass update for:\n  - Gender (Jenis Kelamin)\n  - Class (Kelas) with dropdown selector\n\n## Permission Management\n- **Admin**: Always has access to batch edit feature\n- **Teacher**: Controlled by 'Hak Akses Manajemen Siswa' permission\n- Add new permission: 'batch_edit_students' in student management permissions\n- **Default**: All teachers do NOT have batch edit access (must be explicitly granted)\n- Permission check before showing 'Batch Edit' button\n- Permission check in server action before executing batch update\n\n## User Flow\n1. Click 'Batch Edit' button (only visible if user has permission)\n2. Checkboxes appear in leftmost column\n3. Select students by clicking checkbox or row\n4. Mass update UI appears above table showing selected count\n5. Choose field to update (Gender or Class)\n6. Select new value from dropdown\n7. Confirm and apply changes to all selected students\n\n## Technical Notes\n- Inspired by YouTube batch edit patterns\n- Should integrate with existing student edit functionality\n- Need to handle validation and permissions (including batch edit permission)\n- Update should use server action with proper error handling\n- Revalidate SWR cache after batch update\n- Use existing permission system in studentPermissions.ts\n\n## Files to Modify\n- src/app/(admin)/users/siswa/page.tsx\n- src/app/(admin)/users/siswa/actions.ts (new batch update action)\n- src/app/(admin)/users/siswa/components/* (new batch edit UI)\n- src/lib/studentPermissions.ts (add batch_edit_students permission)\n- src/types/permissions.ts (update types if needed)\n\n## Testing Requirements (TDD)\n- Test batch selection logic\n- Test batch update validation\n- Test permission checks for batch operations (admin vs teacher)\n- Test default permission (teachers should NOT have access)\n- Test error handling for partial failures\n- Test permission enforcement in server action","status":"open","priority":2,"issue_type":"feature","created_at":"2026-02-21T07:05:11.11334+07:00","created_by":"abuabdirohman","updated_at":"2026-02-21T07:12:07.28657+07:00"}
{"id":"sm-hov","title":"Bug: Data table laporan hilang pertemuan saat multi-class filter","description":"## Deskripsi Bug\n\n**Halaman**: /laporan (Data Table)\n**File**: src/app/(admin)/laporan/page.tsx\n\n### Problem\nSaat menampilkan laporan dengan **multiple class filter** (7 kelas sekaligus), jumlah pertemuan yang ditampilkan jauh lebih sedikit dibanding saat filter **single class**.\n\n### Reproduksi\n1. Filter laporan dengan **1 kelas saja** (contoh: Kelas 4)\n   - ‚úÖ Hasil: Menampilkan belasan pertemuan presensi\n   - ‚úÖ Persentase kehadiran per siswa: BENAR\n\n2. Filter laporan dengan **7 kelas sekaligus**\n   - ‚ùå Hasil: Hanya menampilkan 1 pertemuan\n   - ‚ùå Persentase kehadiran per siswa: SALAH (tidak akurat)\n\n### Impact\n- üö® **CRITICAL**: Laporan statistik kehadiran siswa tidak akurat\n- Data pertemuan hilang/ter-filter salah saat multi-class selection\n- Persentase kehadiran menjadi misleading untuk admin/guru\n\n### Root Cause (Hipotesis)\nKemungkinan bug ada di:\n1. **Class filter logic** di `src/app/(admin)/laporan/actions.ts`\n   - Multi-class filter mungkin menggunakan logic yang salah (AND vs OR)\n   - Bisa jadi filter meeting berdasarkan `student.class_id` bukan `meeting.class_ids`\n\n2. **Data aggregation** di DataTable component\n   - Mungkin ada logic yang assume single class only\n\n### Expected Behavior\n- Filter dengan 7 kelas harus menampilkan **SEMUA** pertemuan dari ketujuh kelas tersebut\n- Persentase kehadiran dihitung berdasarkan total pertemuan yang BENAR\n\n### Files to Investigate\n- `src/app/(admin)/laporan/actions.ts` (line ~448-467: class filter logic)\n- `src/app/(admin)/laporan/page.tsx` (DataTable rendering)\n- `src/components/shared/DataFilter.tsx` (multi-select class filter)\n\n### Related to CLAUDE.md\nSee **Filtering \u0026 Reporting Conventions** section:\n\u003e When filtering attendance/reports by class, **ALWAYS filter by meeting's class**, NOT student's enrolled class\n\n---\n\n**GitHub Issue**: https://github.com/abuabdirohman4/generus-mandiri/issues/3","status":"open","priority":1,"issue_type":"bug","created_at":"2026-02-12T09:31:33.418207+07:00","created_by":"abuabdirohman","updated_at":"2026-02-15T05:10:45.671198+07:00","dependencies":[{"issue_id":"sm-hov","depends_on_id":"sm-de3","type":"blocks","created_at":"2026-02-22T15:10:46.20974+07:00","created_by":"abuabdirohman"}]}
{"id":"sm-mln","title":"Refactor student actions - Separation of Concerns (Repository-UseCase pattern)","description":"Refactor src/app/(admin)/users/siswa/actions.ts (1,610 lines) into layered architecture:\n\n**Goals**:\n- Separate database access (Repository), business logic (UseCase), and orchestration (Actions)\n- Make business logic testable (TDD-friendly)\n- Reduce file size from 1,610 ‚Üí ~400 lines per layer\n- Establish pattern for other modules (absensi, laporan)\n\n**New Files**:\n1. src/repositories/studentRepository.ts (14 DB functions)\n2. src/lib/students/studentTransform.ts (data transformation)\n3. src/lib/students/studentValidation.ts (input validation)\n4. src/lib/students/studentUseCases.ts (business logic)\n5. Test files for each layer (200+ tests)\n\n**Modified Files**:\n- src/app/(admin)/users/siswa/actions.ts (thin wrappers)\n- CLAUDE.md (document pattern)\n\n**Approach**: Functional programming (NO classes/OOP)\n**Migration**: Incremental (one function at a time, no breaking changes)\n\nSee detailed plan in session transcript.","notes":"Progress documentation standardized:\n- Moved REFACTORING_PROGRESS.md ‚Üí .beads/progress/sm-mln.md\n- Added mandatory progress doc standard to CLAUDE.md\n- Format: .beads/progress/{issue-id}.md for all multi-session work\n- Benefits: context recovery, TDD tracking, team collaboration","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-20T13:33:07.404954+07:00","created_by":"abuabdirohman","updated_at":"2026-03-01T12:35:46.458444+07:00","closed_at":"2026-03-01T12:35:46.458444+07:00","close_reason":"Superseded by sm-dsw with unified 3-layer functional architecture. Repository-UseCase pattern introduced architectural inconsistency (OOP-style separation). New approach uses functional 3-layer pattern inside domain files, co-located with feature. See docs/plan/refactoring-god-file-decomposition.md for unified pattern.","external_ref":"gh-14"}
{"id":"sm-nol","title":"Dashboard: Add comparison charts and hierarchical teacher access","description":"Add comparison visualization and hierarchical teacher access to dashboard\n\nFeatures:\n1. Guru Desa/Daerah can access dashboard (same scope as Admin equivalents)\n2. Toggle between Table View and Chart View\n3. Comparison level selector (by kelas/kelompok/desa/daerah)\n4. Multi-select entities to compare\n5. Bar chart with weighted average attendance rates\n6. Reuse existing getClassMonitoring() data with client-side aggregation\n\nComponents to create:\n- ComparisonControls.tsx (level + entity selector)\n- ComparisonChart.tsx (Recharts bar chart)\n- Update ClassMonitoringTable.tsx (add toggle)\n- Update dashboardStore.ts (comparison state)\n- Update layout.tsx (hierarchical teacher access)\n\nDesign doc: smooth-doodling-bumblebee.md","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-26T13:07:38.792653+07:00","created_by":"abuabdirohman","updated_at":"2026-02-28T13:49:30.744256+07:00","closed_at":"2026-02-28T13:49:30.744256+07:00","close_reason":"Closed"}
{"id":"sm-pis","title":"Filter empty classes from CreateMeetingModal class selector","description":"## Problem\n\nCreateMeetingModal displays ALL available classes in the class selection dropdown, including classes with 0 active students. This clutters the UI and creates confusion.\n\n## Solution\n\nImplement client-side filtering to hide classes with 0 active students using useMemo for performance.\n\n## Implementation Steps\n\n1. Add classStudentCounts useMemo to compute active student count per class\n2. Modify availableClasses useMemo to filter out classes with count === 0\n3. Handle edge cases (all empty classes, multi-class students, loading state)\n4. Test with various scenarios\n\n## Design Document\n\nSee: docs/plans/2026-02-28-filter-empty-classes-design.md\n\n## Files to Modify\n\n- src/app/(admin)/absensi/components/CreateMeetingModal.tsx (~25 lines)\n\n## Success Criteria\n\n- Classes with 0 active students hidden from selector\n- Existing functionality preserved (role-based access, sorting)\n- No performance degradation","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-28T13:27:49.0678+07:00","created_by":"abuabdirohman","updated_at":"2026-02-28T14:25:43.843676+07:00","closed_at":"2026-02-28T14:25:43.843676+07:00","close_reason":"Closed"}
{"id":"sm-qrt","title":"Setup unit testing infrastructure with Vitest","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-10T08:32:08.430507+07:00","created_by":"abuabdirohman","updated_at":"2026-02-26T10:01:39.652457+07:00","closed_at":"2026-02-26T10:01:40.652457+07:00","close_reason":"‚úÖ Setup complete! Vitest infrastructure ready with:\n- Dependencies installed (vitest, @testing-library, jsdom, coverage-v8)\n- Config files created (vitest.config.ts, test/setup.ts)\n- Supabase mock utilities (test/mocks/supabase.ts)\n- NPM scripts (test, test:run, test:ui, test:coverage)\n- TypeScript types configured\n- Example tests: classHelpers (15 tests, 100% coverage), batchFetching (6 tests, 100% coverage)\n- All tests passing (21/21 ‚úì)","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"sm-s3y","title":"Extract inline types to src/types/","status":"open","priority":3,"issue_type":"task","created_at":"2026-03-01T12:06:38.277011+07:00","created_by":"abuabdirohman","updated_at":"2026-03-01T12:06:38.277011+07:00","dependencies":[{"issue_id":"sm-s3y","depends_on_id":"sm-vpo","type":"blocks","created_at":"2026-03-01T12:07:05.131559+07:00","created_by":"abuabdirohman"}]}
{"id":"sm-uk4","title":"Split remaining actions files (materi, rapot, guru, dashboard, admin)","status":"open","priority":3,"issue_type":"task","created_at":"2026-03-01T12:06:33.251455+07:00","created_by":"abuabdirohman","updated_at":"2026-03-01T12:06:33.251455+07:00","dependencies":[{"issue_id":"sm-uk4","depends_on_id":"sm-vpo","type":"blocks","created_at":"2026-03-01T12:07:01.414697+07:00","created_by":"abuabdirohman"}]}
{"id":"sm-unc","title":"DataFilter Optimization \u0026 Standardization","description":"## Epic: DataFilter Optimization \u0026 Standardization\n\n**Purpose**: Comprehensive optimization and standardization of DataFilter component after all critical bugs are fixed.\n\n## Prerequisites (MUST be completed first)\n- [ ] sm-de3: Auto-clear bug fixed ‚úÖ\n- [ ] sm-hov: Closed (duplicate of sm-de3)\n- [ ] sm-04g: Organisasi filter bug fixed\n- [ ] sm-8yt: Layout 3 filters fixed\n\n## Scope\n\n### Phase 1: Code Cleanup\n- [ ] Remove ALL debug console.log statements\n  - DataFilter.tsx (lines 361-376, 396, 409-415, 425, etc.)\n  - Siswa page (lines 70-106)\n  - Laporan page (lines 31-74)\n- [ ] Remove commented code and dead code paths\n- [ ] Consolidate duplicate filter logic (if any found during bug fixes)\n\n### Phase 2: Performance Optimization\n- [ ] Audit useMemo dependencies (ensure minimal re-renders)\n- [ ] Consider React.memo for filter components\n- [ ] Optimize class list deduplication algorithm\n- [ ] Profile component with React DevTools\n\n### Phase 3: Architecture Review\n- [ ] Document DataFilter props and behavior\n- [ ] Create type definitions for filter configurations\n- [ ] Standardize filter state management pattern\n- [ ] Consider extracting complex logic to hooks\n\n### Phase 4: Testing \u0026 Documentation\n- [ ] Write unit tests for DataFilter component\n- [ ] Test edge cases (empty lists, single item, large datasets)\n- [ ] Update CLAUDE.md with DataFilter patterns\n- [ ] Add JSDoc comments to public APIs\n\n## Success Criteria\n- ‚úÖ Zero console.log in production code\n- ‚úÖ Consistent behavior across all pages (Siswa, Absensi, Laporan, Organisasi)\n- ‚úÖ Performance: Filter dropdown opens \u003c100ms with 100+ classes\n- ‚úÖ Test coverage \u003e80% for DataFilter logic\n- ‚úÖ Documentation complete in CLAUDE.md\n\n## Estimated Effort\n- Code cleanup: 2 hours\n- Performance optimization: 3 hours\n- Architecture review: 4 hours\n- Testing \u0026 docs: 4 hours\n**Total: ~13 hours (2 working days)**\n\n## Dependencies\n**Blocks**: None (this is cleanup/optimization)\n**Blocked by**: sm-de3, sm-04g, sm-8yt (must fix bugs first)\n\n## Notes\n- This epic should ONLY be started after ALL bug fixes are verified and merged\n- Focus on standardization, not feature additions\n- Keep backward compatibility with existing pages","status":"open","priority":2,"issue_type":"epic","created_at":"2026-02-22T15:13:00.963215+07:00","created_by":"abuabdirohman","updated_at":"2026-02-22T15:13:20.91068+07:00","dependencies":[{"issue_id":"sm-unc","depends_on_id":"sm-de3","type":"blocks","created_at":"2026-02-22T15:13:26.560359+07:00","created_by":"abuabdirohman"},{"issue_id":"sm-unc","depends_on_id":"sm-04g","type":"blocks","created_at":"2026-02-22T15:13:26.791744+07:00","created_by":"abuabdirohman"},{"issue_id":"sm-unc","depends_on_id":"sm-8yt","type":"blocks","created_at":"2026-02-22T15:13:27.039813+07:00","created_by":"abuabdirohman"}]}
{"id":"sm-vpo","title":"Split absensi/actions.ts into actions/ folder (PILOT)","status":"open","priority":2,"issue_type":"task","created_at":"2026-03-01T12:06:20.201275+07:00","created_by":"abuabdirohman","updated_at":"2026-03-01T12:06:20.201275+07:00"}
{"id":"sm-x9a","title":"Enhancement: Show kelompok name in class label for desa-level users in AssignStudentsModal","description":"\n## Problem\nWhen desa-level admin users assign students to classes in AssignStudentsModal, the class dropdown only shows class names without kelompok information. This makes it difficult to identify which kelompok each class belongs to, especially when multiple kelompoks have classes with the same name.\n\n## Location\nFile: src/app/(admin)/users/siswa/components/AssignStudentsModal.tsx\nLine: 165\nCurrent code:\n```typescript\nlabel: cls.name,\n```\n\n## Expected Behavior\nFor desa-level users (admin_desa), the class label should include kelompok name:\n- Format: \"{kelompok_name} - {class_name}\"\n- Example: \"Kelompok A - Pra Nikah\" instead of just \"Pra Nikah\"\n\nFor other user levels (superadmin, admin_daerah, admin_kelompok, teacher):\n- Keep current behavior (class name only)\n\n## Implementation Notes\n1. Check user profile level (isAdminDesa from @/lib/userUtils)\n2. Ensure classes data includes kelompok relation\n3. Update label conditionally based on user level\n4. Test with desa-level admin account\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T20:21:10.443129+07:00","created_by":"abuabdirohman","updated_at":"2026-02-26T10:01:39.652457+07:00","closed_at":"2026-02-26T10:01:40.652457+07:00","close_reason":"Implemented conditional label for class dropdown. For admin_desa users, label shows 'Kelompok Name - Class Name', for other users shows 'Class Name' only.","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
