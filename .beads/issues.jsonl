{"id":"sm-a0y","title":"Refactor: Optimize absensi/actions.ts (2215 â†’ ~900 lines)","description":"Mengurangi kompleksitas dan duplikasi kode di src/app/(admin)/absensi/actions.ts dengan memecah logika berulang menjadi utility functions yang reusable.\n\n## ğŸ¯ Objectives\n- Reduce from 2215 lines to ~900 lines (-59%)\n- Eliminate ~1300 lines of duplicated code (-96%)\n- Split getMeetingsWithStats (986 lines â†’ ~200 lines per function)\n- Improve testability and maintainability\n\n## ğŸ“Š Problem Analysis\n\n### Duplicated Code Identified:\n1. **Data Transformation Logic** (~360 lines duplicate)\n   - Transform array to object (kelompok/desa/daerah): 12x repetitions\n   - Build class names array: 6x repetitions\n   - Build allClasses array: 4x repetitions\n\n2. **Filter Logic** (~200 lines duplicate)\n   - Teacher class filtering: 3x repetitions\n   - Admin hierarchy filtering: 3x repetitions\n   - Pengajar access logic: 4x repetitions\n\n3. **Stats Calculation** (~300 lines duplicate)\n   - Attendance percentage calculation: 3x repetitions\n   - Student filtering by role: 3x repetitions\n   - Stats enrichment: 3x repetitions\n\n4. **Query Patterns** (~150 lines duplicate)\n   - Fetch classes with hierarchy: 6x repetitions\n   - Build class maps: 5x repetitions\n   - Fetch student-class mappings: 3x repetitions\n\n5. **Auth \u0026 Validation** (~100 lines duplicate)\n   - User + profile fetch: 8x repetitions\n   - Teacher class validation: 2x repetitions\n   - Student validation: 3x repetitions\n\n## ğŸ”§ Implementation Phases\n\n### Phase 1: Extract Data Transformation Utilities (Reduction: ~310 lines)\n**Create:** src/lib/utils/dataTransformers.ts\n**Functions:**\n- transformClassWithHierarchy(classData)\n- transformMeetingClasses(meeting)\n- buildAllClassesArray(meeting, allClassesMap)\n- buildClassNamesArray(meeting, classNameMap)\n\n### Phase 2: Extract Query Helpers (Reduction: ~140 lines)\n**Create:** src/lib/utils/queryHelpers.ts\n**Functions:**\n- fetchClassesWithHierarchy(supabase, classIds)\n- buildClassMaps(classesData)\n- fetchStudentClassMappings(supabase, studentIds)\n\n### Phase 3: Extract Meeting Filter Logic (Reduction: ~340 lines)\n**Create:** src/app/(admin)/absensi/utils/meetingFilters.ts\n**Functions:**\n- filterMeetingsByTeacherClasses(meetings, teacherClassIds, ...)\n- filterMeetingsByAdminLevel(meetings, profile, ...)\n- checkPengajarAccess(meeting, teacherKelompokIds, classDetailsMap)\n\n### Phase 4: Extract Stats Calculation (Reduction: ~400 lines)\n**Create:** src/app/(admin)/absensi/utils/statsCalculators.ts\n**Functions:**\n- calculateMeetingStats(meeting, attendanceByMeeting, relevantStudentIds)\n- processRoleBasedStudentFilter(meeting, profile, ...)\n- enrichMeetingsWithStats(meetings, attendanceByMeeting, ...)\n\n### Phase 5: Extract Auth \u0026 Validation (Reduction: ~140 lines)\n**Create:** src/app/(admin)/absensi/utils/authHelpers.ts\n**Functions:**\n- getCurrentUserWithProfile(supabase, fields?)\n- validateTeacherClasses(adminClient, teacherId, classIds)\n- validateStudentSelection(adminClient, classIds, studentIds)\n\n### Phase 6: Split getMeetingsWithStats (Reduction: ~200 lines)\n**Create:** src/app/(admin)/absensi/utils/meetingQueries.ts\n**Structure:**\n- getMeetingsWithStats() - Main orchestrator (~100 lines)\n- getTeacherMeetingsWithStats() - Teacher-specific (~200 lines)\n- getAdminMeetingsWithStats() - Admin-specific (~180 lines)\n- getFallbackMeetingsWithStats() - Fallback (~100 lines)\n\n### Phase 7: Refactor actions.ts\n**Update all functions to use new utilities:**\n- createMeeting - Use authHelpers \u0026 validation\n- getMeetingById - Use dataTransformers\n- updateMeeting - Use authHelpers \u0026 validation\n- getMeetingsWithStats - Import from meetingQueries\n- getStudentsFromSnapshot - Use dataTransformers\n\n## ğŸ“‚ New File Structure\nsrc/lib/utils/\nâ”œâ”€â”€ dataTransformers.ts [NEW - ~150 lines]\nâ”œâ”€â”€ queryHelpers.ts [NEW - ~120 lines]\n\nsrc/app/(admin)/absensi/utils/\nâ”œâ”€â”€ authHelpers.ts [NEW - ~100 lines]\nâ”œâ”€â”€ meetingFilters.ts [NEW - ~200 lines]\nâ”œâ”€â”€ statsCalculators.ts [NEW - ~180 lines]\nâ”œâ”€â”€ meetingQueries.ts [NEW - ~150 lines]\n\nsrc/app/(admin)/absensi/\nâ””â”€â”€ actions.ts [REFACTORED - ~900 lines]\n\n**Total New Files:** 6\n**Total New LOC:** ~900 lines (reusable utilities)\n**Total Removed LOC:** ~1300 lines (duplications)\n**Net Reduction:** -400 lines + better modularity\n\n## âœ… Acceptance Criteria\n- [ ] No duplicated logic (\u003c 50 lines duplication)\n- [ ] All functions \u003c 200 lines\n- [ ] All utilities have TypeScript interfaces\n- [ ] All utilities have JSDoc comments\n- [ ] All existing tests pass\n- [ ] Unit tests for new utility functions\n- [ ] No performance regression\n- [ ] Type checking passes (npm run type-check)\n- [ ] No new ESLint warnings\n- [ ] All public API signatures unchanged\n- [ ] Existing SWR hooks still work\n\n## ğŸ“Š Success Metrics\n| Metric | Before | After | Target |\n|--------|--------|-------|--------|\n| Total LOC (actions.ts) | 2215 | ~900 | -59% |\n| Duplicated code | ~1300 | ~50 | -96% |\n| Longest function | 986 lines | ~200 lines | -80% |\n| Cyclomatic complexity | High | Low | âœ… |\n| Utility files | 3 | 9 | Modular |\n\n## ğŸ”„ Migration Strategy\n**Approach:** Incremental refactoring (backward compatible at each step)\n1. Phases 1-5: Create utilities without using them â†’ 0 risk\n2. Phase 6-7: Refactor one function at a time â†’ Test each change\n3. Each phase can be committed separately\n4. Rollback plan: Revert specific commit if issues arise\n\n## ğŸ§ª Testing Strategy\n**Unit Tests:** Test each utility function independently\n**Integration Tests:** All existing API tests must pass\n**Manual Testing:** Test with different user roles (teacher, admin, superadmin)\n\n## ğŸ› Known Risks \u0026 Mitigation\n**Risk 1:** Breaking existing functionality\n**Mitigation:** Keep all public APIs unchanged, test each phase\n\n**Risk 2:** Performance regression\n**Mitigation:** Measure query counts before/after, use same Supabase clients\n\n**Risk 3:** Type errors in complex transformations\n**Mitigation:** Strong typing for all utilities, unit tests for edge cases\n\n## ğŸ“… Timeline Estimate\n| Phase | Estimated Time | Risk Level |\n|-------|----------------|------------|\n| Phase 1 | 2 hours | Low |\n| Phase 2 | 1.5 hours | Low |\n| Phase 3 | 3 hours | Medium |\n| Phase 4 | 2.5 hours | Medium |\n| Phase 5 | 2 hours | Low |\n| Phase 6 | 3 hours | Medium |\n| Phase 7 | 4 hours | High |\n| Testing | 3 hours | - |\n| **Total** | **~21 hours** | **Medium** |\n\n## ğŸ“ Notes\n- This refactoring does NOT change any business logic\n- All RLS policies remain the same\n- Database queries are unchanged (only reorganized)\n- Existing SWR cache keys remain compatible\n- No changes to UI components needed\n\n## ğŸ”— Related Files\n**Files to Modify:**\n- src/app/(admin)/absensi/actions.ts\n\n**Files to Create:**\n- src/lib/utils/dataTransformers.ts\n- src/lib/utils/queryHelpers.ts\n- src/app/(admin)/absensi/utils/authHelpers.ts\n- src/app/(admin)/absensi/utils/meetingFilters.ts\n- src/app/(admin)/absensi/utils/statsCalculators.ts\n- src/app/(admin)/absensi/utils/meetingQueries.ts\n\n**Files to Reference:**\n- src/lib/utils/classHelpers.ts (existing patterns)\n- src/lib/utils/batchFetching.ts (existing patterns)\n- src/app/(admin)/laporan/actions.ts (similar complexity)\n\n## âœ¨ Future Improvements\nAfter this refactoring:\n1. Apply same patterns to laporan/actions.ts (~900 lines)\n2. Extract common attendance filtering to shared utilities\n3. Add performance monitoring/telemetry\n4. Implement request caching at server action level","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T07:42:57.808618+07:00","created_by":"abuabdirohman","updated_at":"2026-01-10T07:42:57.808618+07:00","labels":["absensi","code-quality","refactoring","technical-debt"]}
